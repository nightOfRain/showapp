<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Hello MUI</title>
<meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1,user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black">
<link href="css/lib/zzlcss/menu11.css" rel="stylesheet">	
<link rel="stylesheet" href="css/common.css">
<link rel="stylesheet" href="hello-mui/css/mui.min.css">
<link rel="stylesheet" href="hello-mui/css/app.css">
<script src="hello-mui/js/mui.min.js"></script>
<script type="text/javascript" src="js/lib/jQuery/jquery-2.0.0.min.js"></script>
<script type="text/javascript" src="js/lib/bootstrap3.0/bootstrap.min.js"></script>
<script type="text/javascript" src="js/nt_zuobiao.js"></script>
<script type="text/javascript" src="js/lib/zzljs/menu11_com.js"></script>
<script type="text/javascript" src="http://api.map.baidu.com/api?v=2.0&ak=kZ76MkTNOIQ1VnidegnnxbKc"></script>
<script src="js/index.js" type="text/javascript" charset="utf-8"></script>
<style type="text/css">

html, body {
    position: relative;
    height: 100%;
}
body {
    background: #fff;
    font-family: Helvetica Neue, Helvetica, Arial, sans-serif;
    font-size: 14px;
    color:#000;
    margin: 0;
    padding: 0;
}

#map{
	-webkit-transition: all 400ms ease;
	-moz-transition: all 400ms ease;
	-ms-transition: all 400ms ease;
	-o-transition: all 400ms ease;
	transition: all 400ms ease;
}


@-webkit-keyframes am-rotate2{
	from{background-position:0 0}
	to{background-position:-444px 0}
}

</style>
</head>

<body>
   	<header class="mui-bar head_color">
		<a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left" onclick="back_history();" ></a>
		<a  class="mui-action-menu mui-icon mui-icon-paperplane mui-pull-right" onclick="upload_location();"></a>
		<h1 class="mui-title" style="font-weight:bold;">位置调整</h1>
	</header>

	<div class="container-fluid">
		<div id="map" style="height:300px;"></div>
	</div>
	
	<div class="div_fullscreen_map"  style="display:none">
		<div class="mui-content">	
			<div class="mui-scroll-wrapper"> 											
			    <div class="mui-scroll" style="background-color:rgba(247,247,247,8.0);">				    	
	 				<ul id="zzxx" class="mui-table-view">
	 	
	 				</ul>
				</div>	
			</div>			
		</div>
	</div>
	
<script type="text/javascript">
var map,map_H,myGeo,point,mypoint,newpoint,cpoint;
var localSearch;
var infoWindow,infohtml="";
var ntzb=new NTzuobiao();//实例化坐标转换类
var maxmk=50;//每类显示的最大marker数
var curt=0;//当前类,1为网点，2为网格员 etc...
var icon=[];//保存4类markers图标图案
var mkarr=[[],[],[],[]];//保存4类markers
var status_v=[0,0,0,0];
var wdwz_bq; 
var myPosition=0;
var wdh;
var move_count = 0;
var myPos;
var tempmarker;
var mySquare;
var close_flag = 0;
var upload_address='';
var upload_locations='';
$(function() {
	//调整map高度
	
	var winH = window.top.win_H;

	map_H=winH;
	$("#map").css("height", map_H + "px");
	jQuery('#process_s').css("display", "block");
	window.top.getmylocation(buildmap);

	/*每隔5秒钟抓下我的位置*/

	var intervalid = setInterval(function(){		
		
		window.top.getmylocation_r(cxdw);
		
	}, 5000);
	//初始化mui
	mui.init({
		swipeBack:true //启用右滑关闭功能
	});
	/*初始化滚动条*/
	mui('.mui-scroll-wrapper').scroll({
        deceleration: 0.0005 //flick 减速系数，系数越大，滚动速度越慢，滚动距离越小，默认值0.0006
    });
	//返回键 tap事件监听
	mui(document.body).on('tap', '.mui-action-back ', function(e) {
  		this.click();
  	});
	
});
function upload_location(){
	top.confirmInfo("当前地址为"+upload_address+",是否确定更新?", function(msg){
		
		if(upload_locations == ''){
			top.alertInfo("没有获取到坐标,无法上传");
			return ;
		}
		if(msg == 1){ //确定
						top.update_map_address(upload_address);
			//parent.update_address(upload_address);
			back_history();
		}
	});
}
function myposition(){
	setTimeout(function(){		
		document.getElementById('wdwz').src='img/wdwz.png';
	}, 500);
	window.top.getmylocation_r(cxdw);

	myPosition=1;
}


function cxdw(msg){
	if( map ){
		cpoint=msg;
		var parr = msg.split(',');
		point=new BMap.Point(parr[0],parr[1]);
		upload_locations=parr[0]+','+parr[1];
		myPos.setPosition(point);
			
		if( myPosition == 1)
		{
			map.panTo(point); //屏幕中心滑动至point
			myPosition = 0;
		}
		
	}else{
		buildmap(msg);
	}
	
}
function buildmap(msg) {

	cpoint=msg;

	map = new BMap.Map("map",{enableMapClick:false});
	//var parr=ntzb.wgs84tobd09(msg.lon,msg.lat);
	var parr = msg.split(',');
	point=new BMap.Point(parr[0],parr[1]);	
	upload_locations=parr[0]+','+parr[1];
	map.centerAndZoom(point, 19);	

	myPos = new BMap.Marker(point);
	map.addOverlay(myPos);
	 
	infoWindow = new BMap.InfoWindow(infohtml);
	infoWindow.disableAutoPan();
	myGeo = new BMap.Geocoder();
	localSearch = new BMap.LocalSearch();
	
	setdidian();

}

function setdidian(){
	
	var mOption = {
		    poiRadius : 500,           //半径为1000米内的POI,默认100米    
		    numPois : 12				//poi上限12
	};
	myGeo.getLocation(point, function(result){      		
    	if (result){
			//$("#dqwz").html(result.address);			
			var zzxx = document.getElementById("zzxx");
		    
		    while(zzxx.hasChildNodes()) //当div下还存在子节点时 循环继续
		    {
		    	zzxx.removeChild(zzxx.firstChild);
		    }

	    	for(var i=0; i < result.surroundingPois.length; i++ ){
				  
				var li = document.createElement("li"); 
				li.setAttribute("class", "mui-table-view-cell");
			//	li.setAttribute("style", "height:30px;line-height:30px;");
				li.setAttribute("onclick", "setMyposition('"+result.surroundingPois[i].point.lng+"','"+result.surroundingPois[i].point.lat+"','"+result.surroundingPois[i].address+"','"+result.surroundingPois[i].title+"')");
				
				var a_a=document.createElement("a");
				
				a_a.setAttribute("class", "mui-navigate-right");
				a_a.innerHTML = result.surroundingPois[i].title +" "+result.surroundingPois[i].address;
				
	
				
				li.appendChild(a_a);
				
				
				
				zzxx.appendChild(li);
				
	    		if(i == 0){
	    			var mPoint=new BMap.Point(result.surroundingPois[i].point.lng,result.surroundingPois[i].point.lat);
	    			map.panTo(point); //屏幕中心滑动至point
	    		}
	    	}
    	
			$(".div_fullscreen_map").fadeIn(2000);
    	}      
	}, mOption);
	

}


function setMyposition(lng, lat, address, title){
	
	if( tempmarker ){
		map.removeOverlay(tempmarker);
		map.removeOverlay(mySquare);
	}
	var mPoint=new BMap.Point(lng,lat);
	var myIcon = new BMap.Icon("img/maodian.png", new BMap.Size(32, 32), {    
	// 指定定位位置。   
	// 当标注显示在地图上时，其所指向的地理位置距离图标左上    
	// 角各偏移10像素和25像素。您可以看到在本例中该位置即是   
	   // 图标中央下端的尖角位置。    
	   offset: new BMap.Size(10, 25),    
	   // 设置图片偏移。   
	   // 当您需要从一幅较大的图片中截取某部分作为标注图标时，您   
	   // 需要指定大图的偏移位置，此做法与css sprites技术类似。    
	   imageOffset: new BMap.Size(0, 0 )   // 设置图片偏移    
	 }); 
	tempmarker = new BMap.Marker(mPoint, {icon: myIcon});
	mySquare = new SquareOverlay(mPoint, 100,  "", "我的位置"); 

	map.panTo(mPoint); //屏幕中心滑动至point
	map.addOverlay(tempmarker);
	map.addOverlay(mySquare);
	
	$("#dqwz").html(address);
	upload_address=title+address;
	upload_locations=lng+','+lat;
	localStorage.setItem("address", address);
	localStorage.setItem("title", title);
	localStorage.setItem("lat", lat);
	localStorage.setItem("lng", lng);
	//parent.update_address(address);
	top.update_map_address(address);
	top.address_gps = address;
	back_history();

}
//定义自定义覆盖物的构造函数    
function SquareOverlay(center, length, color,text){      
  	this._center = center;      
  	this._length = length;      
  	this._color = color;      
  	this._text = text;    
}      
//继承API的BMap.Overlay      
SquareOverlay.prototype = new BMap.Overlay();
// 实现初始化方法    
SquareOverlay.prototype.initialize = function(map){      
	//保存map对象实例     
  	this._map = map;          
	//创建div元素，作为自定义覆盖物的容器     
  	var div = document.createElement("div");      
  	div.style.position = "absolute";          
	//可以根据参数设置元素外观     
  	div.style.width = this._length + 20 +"px";      
  	div.style.height = this._length - 82 + "px";      
  	div.style.background = this._color; 
  	div.innerText =this._text;
  	div.style.color="#bb0000";
	div.style.fontSize="12px";
	div.style.fontFamily="微软雅黑";

	//将div添加到覆盖物容器中     
  	map.getPanes().markerPane.appendChild(div);        
	//保存div实例     
  	this._div = div;        
	//需要将div元素作为方法的返回值，当调用该覆盖物的show、     
	//hide方法，或者对覆盖物进行移除时，API都将操作此元素。     
  	return div;      
}
//实现显示方法      
SquareOverlay.prototype.show = function(){      
	if (this._div){      
		this._div.style.display = "";      
	}      
}        
//实现隐藏方法    
SquareOverlay.prototype.hide = function(){      
	if (this._div){      
	      this._div.style.display = "none";      
	}      
}
//实现绘制方法     
SquareOverlay.prototype.draw = function(){      
	//根据地理坐标转换为像素坐标，并设置给容器      
	var position = this._map.pointToOverlayPixel(this._center);      
	this._div.style.left = position.x  + 14 + "px";      
	this._div.style.top = position.y - 4 + "px";      
}
</script>
	</body>
</html>
