<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title></title>
<link href="js/lib/bootstrap3.0/bootstrap.css" rel="stylesheet">		
<link href="css/lib/zzlcss/menu11.css" rel="stylesheet">
<link rel="stylesheet" href="css/common.css">
<link rel="stylesheet" href="hello-mui/css/mui.min.css">
<link rel="stylesheet" type="text/css" href="hello-mui/css/app.css" />
<script src="hello-mui/js/mui.min.js"></script>
<script type="text/javascript" src="js/lib/jQuery/jquery-2.0.0.min.js"></script>
<script type="text/javascript" src="js/lib/bootstrap3.0/bootstrap.min.js"></script>
<script type="text/javascript" src="js/lib/zzljs/menu11_com.js"></script>
<script src="js/index.js" type="text/javascript" charset="utf-8"></script>
<style>
html, body {
    position: relative;
    height: 100%;
}
body {
    background: #fff;
    font-family: Helvetica Neue, Helvetica, Arial, sans-serif;
    font-size: 14px;
    color:#000;
    margin: 0;
    padding: 0;
    overflow:auto;
 
}
.div_fullscreen_pg{
        
        z-index:9998;background-color:rgba(2,2,2,0.8);width:100%;height:100%;position: fixed;top:0px;
    }

.div_process{
       
    z-index:9999;background-color:#FFFFFF; width:100%;position: fixed; bottom:0;left:0;text-align:left;
        
}
h5.mui-content-padded {
	margin-left: 3px;
	margin-top: 20px !important;
}
h5.mui-content-padded:first-child {
	margin-top: 12px !important;
}
.ui-alert {
	text-align: center;
	padding: 20px 10px;
	font-size: 16px;
}


.head_color{
	background-color: #18b4ed;
}
.mui-input-row input{
	font-size:15px;
	color:#8e8e8e;
}
.mui-input-row textarea{
	font-size:15px;
	color:#8e8e8e;
}
</style>
<script>

var thisURL; 
var activeIndex = 0; //0-企业用户 1-个人用户
var institution = 0; //合作机构编号
var bondingCompany = 0; //担保公司编号
var pgCompany = 0; //评估公司编号
var fileno;
var star = 0;
var flag = 0;//0-企业用户1-个人用户
var pgCompany = 0;
var pgCompanyName='';
var curr_assess_id=0;
$(function() {			
	  
	//$("#qy_div").show();
	
	var thisURL = document.URL; 
	 var getenv = thisURL.split('?')[1];
     localStorage.setItem("list_flag", '1');
     fileno = getenv.split('=')[1];
    
	mui.init({
		swipeBack:true //启用右滑关闭功能
	});
	mui('.mui-scroll-wrapper').scroll({
              deceleration: 0.0005 //flick 减速系数，系数越大，滚动速度越慢，滚动距离越小，默认值0.0006
              });
	mui(document.body).on('tap', '.mui-action-back', function(e) {
		this.click();
		return false;
	});
	initPage();
	$("input").attr("readonly", "readonly");
	
 
	
	//企业、个人模块切换监听
	document.querySelector('.mui-table-view.mui-table-view-radio').addEventListener('selected',function(e){
		//info.innerHTML = "当前选中的为："+e.detail.el.innerText;
		console.log(e.detail.el.id);
		pgCompanyName = e.detail.el.innerText;
		pgCompany = e.detail.el.id;
		
		if(flag == 0){ //企业客户
			$("#pg_name_qy").val(pgCompanyName);
		}else if(flag == 1){ //个人客户
			$("#pg_name_gr").val(pgCompanyName);
		}
		
	});
	
	//退回按钮监听
	
	mui(document.body).on('tap', '.back_class', function(e) {
		//	e.detail.gesture.preventDefault(); //修复iOS 8.x平台存在的bug，使用plus.nativeUI.prompt会造成输入法闪一下又没了
			var btnArray = ['取消', '确定'];
			mui.prompt('请说明回退具体原因，10字左右', '请说明回退原因 ', '回退确认', btnArray, function(e) {
				if (e.index == 1) {		
					
					if(e.value.length < 1){
					//	mui.toast("");
						top.alertInfo("回退原因不能为空");
						
					}else{
						
						var data = {
								user_id:localStorage.getItem("user_id"),
								fileno:fileno,
								note:e.value
			        		};		
						Http_ajax(function(msg){
							top.writelog("6043="+msg);
							top.stop_process();
							top.alertInfo("回退成功");
							parent.initPage();
							back_history();
						}, "app/6043", data);
					}
				} else {
					
				}
			});
			
		});
});  



function initPage(){
	var data = {
            fileno:fileno           
    };
	
	Http_ajax(done_check_info, "app/6041", data);
}

function done_check_info(msg){

	top.writelog("6041 recv:"+msg);
	top.stop_process();
	var json = eval("("+msg+")");
	
	if(json.stat == '1'){
		top.alertInfo("查询失败，请把该笔记录信息上报管理员处理");
		return;
	}
	flag = json.data.fileinfo.flag;
	var login_user = localStorage.getItem("user_id");
	
	curr_assess_id = json.data.fileinfo.assess_id;
	var user_type = localStorage.getItem("user_type");
	top.writelog("user_type="+user_type);
	top.writelog("fileno="+fileno+";stat="+json.data.fileinfo.stat);
	if(json.data.fileinfo.flag == '1'){ //个人
		$("#gr_div").show();
		$("#qy_div").hide();
	//	getValue_by_key(data, 'gezh');
		$("#customer_gr").val(json.data.fileinfo.customer); //客户名称
		$("#tel_no_gr").val(json.data.fileinfo.tel_no); //联系方式
		$("#pawn_flag_gr").val(json.data.fileinfo.pawnName + json.data.fileinfo.pawnSmall); //抵押物类型
		$("#pawn_address_gr").val(json.data.fileinfo.pawn_address_text); //具体地址
		$("#region_gr").val(json.data.fileinfo.area_name); //支行所处区域
		if(!top.isEmpty(json.data.fileinfo.agency_id)){
			$("#zj_div").show();
			$("#institution_name").val(json.data.fileinfo.agency_id); //合作机构
			$("#institution_lxr").val(json.data.fileinfo.agency_lxr); //合作机构
			$("#institution_lxfs").val(json.data.fileinfo.agency_lxfs); //合作机构
			
		}
		if(user_type == '0'){//客户经理
			if(json.data.fileinfo.stat == 0 ){ //未处理时客户经理看不到评估公司
				$("#pg_name_gr").val("具体分派评估公司稍后通知"); //评估公司
				
			}else{
				$("#pg_name_gr").val(json.data.fileinfo.assess_name); //评估公司
				$("#person_gr").val(json.data.fileinfo.person); //评估公司联系人
				$("#person_phone_gr").val(json.data.fileinfo.person_phone);//评估公司联系方式
				$("#pggs_info_gr").show();
				if(json.data.fileinfo.star > 1){ //已经打过份了
					
					$("#div_star_gr").show();
					$("#pg_star_gr").val(json.data.fileinfo.star);
				}else{
					if(login_user.toLowerCase() == json.data.fileinfo.user_id.toLowerCase()){
						$(".dafen").show();
					}
				}
			}
		}else{//管理员

				$("#pg_name_gr").val(json.data.fileinfo.assess_name); //评估公司
				$("#person_gr").val(json.data.fileinfo.person); //评估公司联系人
				$("#person_phone_gr").val(json.data.fileinfo.person_phone);//评估公司联系方式
				$("#pggs_info_gr").show();
				if(json.data.fileinfo.star > 1){ //已经打过份了
					
					$("#div_star_gr").show();
					$("#pg_star_gr").val(json.data.fileinfo.star);
				}
			
		}

		
	}else{ //企业
		$("#gr_div").hide();
		$("#qy_div").show();
		$("#customer_qy").val(json.data.fileinfo.customer); //客户名称
		$("#tel_name_qy").val(json.data.fileinfo.tel_name); //联系人
		$("#tel_no_qy").val(json.data.fileinfo.tel_no); //联系方式
		$("#pawn_flag_qy").val(json.data.fileinfo.pawnName + json.data.fileinfo.pawnSmall); //抵押物类型
		$("#pawn_address_qy").val(json.data.fileinfo.pawn_address_text); //具体地址
		$("#region_qy").val(json.data.fileinfo.area_name); //支行所处区域
		
		if(user_type == '0'){//客户经理
			if(json.data.fileinfo.stat == '0'){ //未处理时客户经理看不到评估公司
				$("#pg_name_qy").val("具体分派评估公司稍后通知"); //评估公司
			}else{
				$("#pg_name_qy").val(json.data.fileinfo.assess_name); //评估公司
				$("#person_qy").val(json.data.fileinfo.person); //评估公司联系人
				$("#person_phone_qy").val(json.data.fileinfo.person_phone);//评估公司联系方式
				$(".pggs_info").show();
				if(json.data.fileinfo.star > 1){ //已经打过份了
					
					$("#div_star_qy").show();
					$("#pg_star_qy").val(json.data.fileinfo.star);
				}else{
					if(login_user.toLowerCase() == json.data.fileinfo.user_id.toLowerCase()){
						$(".dafen").show();
					}
				}
			}
		}else{
			$("#pg_name_qy").val(json.data.fileinfo.assess_name); //评估公司
			$("#person_qy").val(json.data.fileinfo.person); //评估公司联系人
			$("#person_phone_qy").val(json.data.fileinfo.person_phone);//评估公司联系方式
			$(".pggs_info").show();
			if(json.data.fileinfo.star > 1){ //已经打过份了
				
				$("#div_star_qy").show();
				$("#pg_star_qy").val(json.data.fileinfo.star);
			}
		}
		
		
	}
	
	
	
	
	if( user_type == 1){ //管理员
		
		if(json.data.fileinfo.stat == 0) { //短信未发送
		
			$(".back_button").show();
			$(".div_button").show();
			
			if(json.data.pgList.length > 1){ //有可以修改的评估公司共选择
				$(".modify_button").show();
				$("#pggs").html('');
				var pggs_html = '';
				
				for( var i = 0; i < json.data.pgList.length; i++){
					pggs_html += '<li class="mui-table-view-cell" id='+json.data.pgList[i].rid+'><a class="mui-navigate-right">'+json.data.pgList[i].assess_name+'</a></li>'
				}
				
				$("#pggs").html(pggs_html);
				
				if(flag == 1){
					$("#pg_name_gr").attr("onclick", "show_pggs()");
				}else if(flag == 0){
					$("#pg_name_qy").attr("onclick", "show_pggs()");
				}
								
			}else{
				$(".cannot_modify").show();
			}
			
		}
	}else if( user_type == 0 && json.data.fileinfo.star == 0){//普通客户经理
		//$(".dafen").show();
	}



}


function dafen_fun(){
	
	if(flag == 1){//个人
		star  = $("#star_gr").val();
	}else{ //企业
		star  = $("#star_qy").val();
	}
	if(star < 0 || star > 100){
		top.alertInfo("打分分数需在1-100之间");
		return;
	}

	var data = {
			fileno:fileno,
			star:star
	};

	//通信
	Http_ajax(function(msg){
		
		top.stop_process();
		top.writelog("6034 recv:"+msg);
		top.alertInfo("评价成功");
		parent.initPage();
		back_history();
	}, "app/6034", data);
}

//修改评估结果
function commit(){
	
	if(curr_assess_id == pgCompany || pgCompany == 0 ){
		top.alertInfo("您并未更换评估公司，请点击评估公司输入项，选择确认后提交");
		return;
	}
	var data = {
			user_id:localStorage.getItem("user_id"),
			fileno:fileno,
			assess_id:pgCompany,
			assess_name:pgCompanyName
	};

	//通信
	Http_ajax(function(msg){
		
		top.stop_process();
		top.writelog("6040 recv:"+msg);
		var json =  eval("("+msg+")");
		if(json.data.retcode == 0){
			top.alertInfo("修改成功");
			$(".back_button").show();
			$(".div_button").show();
			$(".modify_button").hide();
			
			parent.initPage();
    		//back_history();

		}
		
	}, "app/6040", data);
}

//发送短信
function send_msg(){
	var data = {
			user_id:localStorage.getItem("user_id"),
			fileno:fileno,

	};
	top.writelog("6039 send:"+JSON.stringify(data));
	$.ajax({
        type : "post",
        timeout: 3000,
        url: "http://"+IP+":"+PORT+"/app/6039",        
        data : data,
        datatype : "application/json",
        success : function(msg){
        	top.stop_process();
    		top.writelog("6039 recv:"+msg);
    		top.alertInfo("发送成功");
    		//parent.initPage();
    		//刷新摇号记录页面
    		top.yaohao_refresh();
    		back_history();
        },
        error:function(msg){
     	   	top.stop_process();
     	  	top.writelog("6039 recv error:"+msg);
     	  	top.alertInfo("短信已交由后台处理，结果会已推送形式返回。");
     	 	top.yaohao_refresh();
 			back_history();
        }
        });
}
//拨号
function call_phone(obj){
	top.call_phone(obj.value);
}

function show_pggs(){
	$(".div_fullscreen_pg").show();
}

function dismiss(){
	$(".div_fullscreen_pg").hide();
}


</script>
</head>
    
<body>
 
   	<header class="mui-bar mui-bar-nav head_color">
		<a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left" onclick="back_history();" ></a>
		<h1 class="mui-title">摇号资料</h1>
	</header>


	<div class="mui-content mui-scroll-wrapper">	
		<div class="mui-scroll" >											
		    <div id="qy_div" style="background-color: #efeff4;display:none;margin-top:25px;">				    	
 					<div class="mui-content-padded" style="margin: 5px;">
						<form class="mui-input-group">
							<div class="mui-input-row">
								<label>客户名称</label>
								<input type="text" id="customer_qy" placeholder="客户名称">
							</div>
							<div class="mui-input-row">
								<label>联系人</label>
								<input type="text" id="tel_name_qy" placeholder="联系人">
							</div>
							<div class="mui-input-row" >
								<label>联系方式</label>
								<input type="text" id="tel_no_qy" placeholder="联系方式" onclick="javascript:call_phone(this);">
							</div>
						</form>
					</div>
					<div class="mui-content-padded" style="margin: 5px;">								
						<form class="mui-input-group" >										
							<div class="mui-input-row">
								<label>类型</label>
								<input type="text" id="pawn_flag_qy" placeholder="抵押物类型" id='pawn_flag_qy' readonly="readonly">
							</div>
							<div class="mui-input-row" style="height:80px;">
								<label>位置</label>								
								<textarea id="pawn_address_qy" rows="2" placeholder="具体地址" readonly="readonly"></textarea>
							</div>
						</form>
					</div>	
					<div class="mui-content-padded" style="margin: 5px;">								
						<form class="mui-input-group" >										
							<div class="mui-input-row">
								<label>地区</label>
								<input type="text" id="region_qy" placeholder="支行所处区域"  readonly="readonly">
							</div>										
						</form>
					</div>	
					<div class="mui-content-padded" style="margin: 5px;">								
						<form class="mui-input-group" >										
							<div class="mui-input-row">
								<label>评估公司</label>
								<input type="text" placeholder="评估公司" id='pg_name_qy' readonly="readonly">
							</div>										
														
							<div class="mui-input-row pggs_info"  style="display:none;">
								<label>联系人</label>
								<input type="text" placeholder="评估公司" id='person_qy' readonly="readonly">
							</div>	
							<div class="mui-input-row pggs_info" style="display:none;">
								<label>联系方式</label>
								<input type="text" placeholder="评估公司" id='person_phone_qy' readonly="readonly" onclick="javascript:call_phone(this);">
							</div>									
						</form>
					</div>		
					<div class="mui-content-padded" style="margin: 5px;">
						<form class="mui-input-group">										
							
							
							<div class="mui-input-row" style="display:none" id='div_star_qy'>
								<label>用户打分</label>
								<input type="text" placeholder="用户打分" id='pg_star_qy' readonly="readonly">
							</div>										
						</form>						
					</div>
					<div class="mui-content-padded dafen" style="margin: 5px; display:none">
						<form class="mui-input-group">										
							<div class="mui-input-row">
								<label>用户打分</label>
								<div class="mui-numbox" style="width: 180px;height: 38px;">
									<button class="mui-btn-numbox-minus" type="button">-</button>
									<input class="mui-input-numbox" type="number" id="star_qy" min="1" max="100" value="90"/>
									<button class="mui-btn-numbox-plus" type="button">+</button>
								</div>
							</div>
						</form>
						<div style="margin-top:10px;text-align:center;margin-bottom: 300px;">
							<button type="button" class="mui-btn  mui-btn-primary" style="width:90%" onclick="dafen_fun();">打分</button>
						</div>
						
					</div>	
					<div style="text-align:center;display:none" class="cannot_modify">
						<p style="color:#ff6600">没有其他可供选择的评估公司</p>
					</div>
					<div style="margin-top:10px;text-align:center;display:none" class="modify_button">
						<button type="button" class="mui-btn  mui-btn-primary" style="width:65%" onclick="commit();" id="qy_button">修改保存</button>
					</div>	
					<div style="margin-top:10px;text-align:center;display:none" class="div_button">
						<button type="button" class="mui-btn  mui-btn-primary" style="width:65%" onclick="send_msg();">短信发送</button>
					</div>			
					<div style="margin-top:10px;text-align:center;margin-bottom: 300px;display:none"  class="back_button">
						<button type="button" class="mui-btn  mui-btn-primary back_class" style="width:65%">退回重新申请</button>
					</div>
					
			 </div>

		    <div id="gr_div"  style="display:none;background-color: #efeff4;margin-top:25px;">
				<div class="mui-content-padded" style="margin: 5px;">						
					<form class="mui-input-group">
						<div class="mui-input-row">
							<label>客户名称</label>
							<input type="text" id="customer_gr" placeholder="客户名称">
						</div>
						
						<div class="mui-input-row">
							<label>联系方式</label>
							<input type="text" id="tel_no_gr" placeholder="联系方式" onclick="javascript:call_phone(this);">
						</div>
					</form>								
				</div>
				<div class="mui-content-padded" style="margin: 5px;">								
					<form class="mui-input-group" >										
						<div class="mui-input-row">
							<label>类型</label>
							<input type="text" placeholder="抵押物类型" id='pawn_flag_gr' readonly="readonly">
						</div>
						<div class="mui-input-row"  style="height:80px;">
							<label>位置</label>
							<textarea id="pawn_address_gr" rows="2" placeholder="具体地址" readonly="readonly"></textarea>
							
						</div>
					</form>
				</div>	
				<div class="mui-content-padded" style="margin: 5px;">								
					<form class="mui-input-group" >										
						<div class="mui-input-row">
							<label>地区</label>
							<input type="text" id="region_gr" placeholder="支行所处区域"  readonly="readonly">
						</div>										
					</form>
				</div>
					
				<div class="mui-content-padded" style="margin: 5px;display:none" id="zj_div">								
					<form class="mui-input-group" >										
						<div class="mui-input-row">
							<label>中介公司</label>
							<input type="text" placeholder="中介公司" id='institution_name' readonly="readonly">
						</div>			
						<div class="mui-input-row ">										
							<label>联系人</label>
							<input type="text" placeholder="请输入房产中介名称" id='institution_lxr' readonly="readonly">
						</div>
						<div class="mui-input-row ">										
							<label>联系方式</label>
							<input type="text" placeholder="请输入房产中介名称" id='institution_lxfs' readonly="readonly">
						</div>											
					</form>
				</div>
					<div class="mui-content-padded" style="margin: 5px;display:none">								
						<form class="mui-input-group" >										
							<div class="mui-input-row">
								<label>担保公司</label>
								<input type="text" placeholder="担保公司" id='bondingCompany_name' readonly="readonly">
							</div>										
						</form>
					</div>	
					<div class="mui-content-padded" style="margin: 5px;">								
						<form class="mui-input-group" >										
							<div class="mui-input-row">
								<label>评估公司</label>
								<input type="text" placeholder="评估公司" id='pg_name_gr' readonly="readonly">
							</div>										
						</form>
						<form class="mui-input-group" id="pggs_info_gr" style="display:none;">										
							<div class="mui-input-row">
								<label>联系人</label>
								<input type="text" placeholder="评估公司" id='person_gr' readonly="readonly">
							</div>	
							<div class="mui-input-row">
								<label>联系方式</label>
								<input type="text" placeholder="评估公司" id='person_phone_gr' readonly="readonly" onclick="javascript:call_phone(this);">
							</div>									
						</form>
					</div>	
					<div class="mui-content-padded" style="margin: 5px;">
						<form class="mui-input-group">										
				
							<div class="mui-input-row" style="display:none" id='div_star_gr'>
								<label>用户打分</label>
								<input type="text" placeholder="用户打分" id='pg_star_gr' readonly="readonly">
							</div>									
						</form>					
					</div>
					
					<div class="mui-content-padded dafen" style="margin: 5px; display:none">
						<form class="mui-input-group">										
							<div class="mui-input-row">
							<label>用户打分</label>
								<div class="mui-numbox" style="width: 180px;height: 38px;">
									<button class="mui-btn-numbox-minus" type="button">-</button>
									<input class="mui-input-numbox" type="number" id="star_gr" min="1" max="100" value="90"/>
									<button class="mui-btn-numbox-plus" type="button">+</button>
								</div>
							</div>
						</form>		
						<div style="margin-top:10px;text-align:center;margin-bottom: 300px;">
							<button type="button" class="mui-btn  mui-btn-primary" style="width:90%" onclick="dafen_fun();">打分</button>
						</div>				
					</div>	
					<div style="text-align:center;display:none" class="cannot_modify">
						<p style="color:#ff6600">没有其他可供选择的评估公司</p>
					</div>
					<div style="margin-top:10px;text-align:center;display:none" class="modify_button">
						<button type="button" class="mui-btn  mui-btn-primary" style="width:65%" onclick="commit();" id="gr_button">修改保存</button>
					</div>
					<div style="margin-top:10px;text-align:center;display:none" class="div_button">
						<button type="button" class="mui-btn  mui-btn-primary" style="width:65%" onclick="send_msg();">短信发送</button>
					</div>			
					<div style="margin-top:10px;text-align:center;margin-bottom: 300px;display:none" class="back_button">
						<button type="button" class="mui-btn  mui-btn-primary back_class" style="width:65%">退回重新申请</button>
					</div>
					
			 </div>
		</div>	
	</div>


       <div class="div_fullscreen_pg" style="display:none">
       		<div class="div_process" style="border-top:1px solid #d0d0d0">
	       		<div class="mui-content" style="background-color:#FFFFFF;margin:5px;">
	       			<div class="mui-content-padded" style="font-weight:bold;text-align:center"><span style="color:#FF6600">当前客户为存量客户，且有多个满足条件的评估公司可供挑选，请选择后点击确认按钮。</span></div>	       			
						       			
					<ul class="mui-table-view mui-table-view-radio" id="pggs">

					</ul>
		
				</div>
				<div class="mui-button-row">
					<button type="button" class="mui-btn mui-btn-primary" onclick="dismiss();">确定</button>&nbsp;&nbsp;
					
				</div>
				<div style="height:30px;">
					<span style="color:#fff">选择评估公司</span>
				</div>
			</div>
       </div> 

    </body>
</html>
