<!DOCTYPE html>
<html>
    <head>
    		<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<title></title>
		<link href="js/lib/bootstrap3.0/bootstrap.css" rel="stylesheet">		
		<link href="css/lib/zzlcss/menu11.css" rel="stylesheet">
	
    
         <link rel="stylesheet" href="css/common.css">
       
        <link rel="stylesheet" type="text/css" href="css/aui/aui.css" />

		
<link rel="stylesheet" href="css/iconfont.css">
    <link rel="stylesheet" href="hello-mui/css/mui.min.css">
        <link rel="stylesheet" href="css/frozen.css">
            <link rel="stylesheet" href="css/demo.css">
            <link rel="stylesheet" href="hello-mui/css/app.css">
                <script src="hello-mui/js/mui.min.js"></script>
		<script type="text/javascript" src="js/lib/jQuery/jquery-2.0.0.min.js"></script>
		<script type="text/javascript" src="js/lib/bootstrap3.0/bootstrap.min.js"></script>
		<script type="text/javascript" src="js/lib/zzljs/menu11_com.js"></script>
		
        <script src="lib/zepto.min.js"></script>
        <script src="js/frozen.js"></script>
        <script src="js/index.js" type="text/javascript" charset="utf-8"></script>
        <style>
           
             html, body {
                 position: relative;
                 height: 100%;
             }
         body {
             background: #fff;
             font-family: Helvetica Neue, Helvetica, Arial, sans-serif;
             font-size: 14px;
             color:#000;
             margin: 0;
             padding: 0;
             -webkit-overflow-scrolling:touch;
             overflow:auto
         }
       p{
       	padding-left:20px;
       }


        </style>
 		<script type="text/javascript">
 		var fileno;
 		var gallery_html='';
		var note_flag = 1;
		var myArray = new Array();
        var count = 0;
        var file_path;
		
		$(function() {				
			
			//调整map高度
			var thisURL = document.URL; 
				localStorage.setItem("thisURL", thisURL);
			localStorage.setItem("thisURL", thisURL);
			fileno = localStorage.getItem("fileno");
			count = 0;
            file_path = localStorage.getItem("group_code");
			top.items_curr=[];

			initPage()
          mui.init({
                   swipeBack:true //启用右滑关闭功能
                   });
          mui('.mui-scroll-wrapper').scroll({
                                            deceleration: 0.0005 //flick 减速系数，系数越大，滚动速度越慢，滚动距离越小，默认值0.0006
                                            });
          mui(document.body).on('tap', '.mui-action-back ', function(e) {
	      		this.click();
	      		return false;
	      	});
		}); 

		function initPage(){
			
			var msg = localStorage.getItem("hb_2_"+fileno);
			var data = eval("("+msg+")");
			if(!data){
				
				return;
			}else{
				
				var images = data.imgurl.split('|');
    			for(var i = 0; i < images.length; i++){
    				if(images[i].length > 0){
    					var imgurl =  top.imgpath+file_path+'/'+images[i];
        				//checkPicurl(imgurl);
        				add_pic(imgurl, images[i]);
    				}
    			}
			}
			
		}

		function pz(){
            
            top.capturePhoto(add_pic);
  
            // showinfo();
        }
		function add_pic(local_url, server_url){
			//每次用最新的一张覆盖，用于主页面展示
			localStorage.setItem("check_hb_2_tmp_image", local_url);
			//添加照片到数组
			myArray.push(server_url);
			
			var gallery = document.getElementById('gallery_2');
			
			var figure = document.createElement("figure");
			figure.setAttribute("class", "aui-col-xs-3");
			
			var div = document.createElement("div");
			div.setAttribute("class", "divcss5");
		
		
			var img = document.createElement("img");
			img.src = local_url;
            var imgurl = top.imgpath+file_path+"/" + server_url;
			checkPicurl(imgurl);
			var figcaption = document.createElement("figcaption");
            img.setAttribute("onclick", "show_photo('"+count+"','2')");
           
           count++;
			div.appendChild(img);
			
			figure.appendChild(div);
			figure.appendChild(figcaption)
		    gallery.appendChild(figure);
							
		}
        function checkPicurl(url){
            
            var img = new Image();
            img.src = url;
            img.onerror = function(){
                top.writelog(url+" 图片加载失败，请检查url是否正确");
                return false;
            };
            
            if(img.complete){
                	top.writelog("complete[url]="+url+":"+img.width+","+img.height);
                localStorage.setItem(url, img.width+","+img.height)
            }else{
                img.onload = function(){
                    top.writelog("onload[url]="+url+":"+img.width+","+img.height);
                    localStorage.setItem(url, img.width+","+img.height);
                    
                    img.onload=null;//避免重复加载
                }
            }
            
        }
    function show_photo(index, num){
        top.items_curr = [];
       
        for(var i = 0; i < myArray.length; i++){
            
            var imgurl = top.imgpath+file_path+"/" + myArray[i];
            
            var size = localStorage.getItem(imgurl);
            var width = size.split(',')[0];
            var height = size.split(',')[1];
         
            var item = {
                src: imgurl,
                w: parseInt(width, 10),
                h: parseInt(height, 10)
            };
            item.title = "业务合作协议";
            top.items_curr.push(item);
        }
        showNewFrame('showimage.html?index='+index+'&num='+num, 'smask');
    }
		function upload_info(){
			
			if(myArray.length < 2){
				top.alertInfo("至少要上传两张客户经验场所图片");
				return;
			}
		
			var data = {
					imgurl:myArray.join('|'),
        			type:localStorage.getItem("hb_type"),
        			num:'2',
        			fileno : localStorage.getItem("fileno"),
        			coordinate:top.coordinate,
        			address:top.address_gps,
        			trandate:get_trandate()
        		};
			top.writelog("businesscheck="+JSON.stringify(data));
			
			Http_ajax(function(msg){
				top.writelog("6025="+msg);
				top.stop_process();
				
				var json = eval("("+msg+")");
				
				if(json.stat == 0){
					localStorage.setItem("hb_2_"+fileno, JSON.stringify(data));
					back_history();
					parent.update_button('2');
					return;
				}else{
					top.alertInfo(json.retinfo);
				}
				
				
			}, "app/6025", data);
			
	        
		}
        function updateItem(num, ind){
            myArray.splice(ind, 1);
            top.writelog("ind="+ind+"after delete:"+myArray);
            var gallery = document.getElementById('gallery_2');
            var list = document.getElementsByTagName('figure');
            
            gallery.removeChild(list[ind]);
        }
		</script>
    </head>                                
	<body style="background-color: #f4f4f4;">
        <header class="mui-bar mui-bar-nav head_color">
			<a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left" onclick="back_history();" ></a>
			<h1 class="mui-title">业务合作协议</h1>
		</header>
        <div class="container-fluid" >
            <div class="mui-content mui-scroll-wrapper" >
                
                <div class="mui-scroll">
			      	<section class="ui-container top_head" style="background-color: #ffffff;padding-top:10px;">			      		
			      		<p>1、合作单位门牌及用印场所照片</p>
			      		<p>2、合作单位接待、负责人员身份证件</p>
			      		<p>3、合作单位准予用印的内部签批资料</p>
			      		<p>4、业务合作协议上用印或签字过程的现场照片（核保双人出镜）</p>
			      		<p>5、接待、负责人员与核保双人合影</p>
			      		<p>6、其他照片（授权委托书等）</p>
						<section id="form">
							<div class="demo-item" >
			       				 <div class="demo-desc" style="text-align:center;font-size:18px;">请拍摄以上照片上传</div>
			       			</div>
						</section>
			        </section>
			        <div class="contain" style="margin: 0 0 0;background-color: #ffffff;border-bottom: 1px solid #d0d0d0;">
						<ul style="width:100%;">
							<li style="display:inline-block;width:100%;">
			        			<!--data-pswp-uid 是每个gallery的id不能重复-->					
								<div class="my-gallery" data-pswp-uid="2" style="width:100%;" id="gallery_2">																
								</div>	
								<div class="aui-col-xs-3"><div class="divcss5"><img src="img/add.png" onclick="pz();"/></div></div>											
							</li>
						</ul>
					</div>

		      	   <section class="ui-container" >
						<section id="form">
							<div class="demo-item" >			       
						        <div class="demo-block"> 
						            <div class="ui-btn-wrap">
						        
						                <button class="ui-btn-lg ui-btn-primary"  style="margin-top:20px;" onclick="upload_info();">
						                  	  保存
						                </button>
						            </div>					
						        </div>
						    </div>
					   	</section>
					</section>  
				</div>
            </div>
        </div>
	</body>


</html>
