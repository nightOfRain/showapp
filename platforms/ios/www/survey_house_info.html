<!DOCTYPE html>
<html>
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<title></title>
		<link href="js/lib/bootstrap3.0/bootstrap.css" rel="stylesheet">		
		<link href="css/lib/zzlcss/menu11.css" rel="stylesheet">
        <link rel="stylesheet" href="css/common.css">

		<link rel="stylesheet" href="hello-mui/css/mui.min.css">
    	<link rel="stylesheet" href="hello-mui/css/app.css">
<link href="hello-mui/css/mui.picker.css" rel="stylesheet" />
<link href="hello-mui/css/mui.poppicker.css" rel="stylesheet" />

		
		<script type="text/javascript" src="js/lib/jQuery/jquery-2.0.0.min.js"></script>
		<script type="text/javascript" src="js/lib/bootstrap3.0/bootstrap.min.js"></script>
       
		<script type="text/javascript" src="js/lib/zzljs/menu11_com.js"></script>
	
  		<script type="text/javascript" src="js/nt_zuobiao.js"></script>
		<script type="text/javascript" src="http://api.map.baidu.com/api?v=2.0&ak=kZ76MkTNOIQ1VnidegnnxbKc"></script>
        <script src="js/index.js" type="text/javascript" charset="utf-8"></script>
<style>
html, body {
    position: relative;
    height: 100%;
}
body {
    background: #fff;
    font-family: Helvetica Neue, Helvetica, Arial, sans-serif;
    font-size: 14px;
    color:#000;
    margin: 0;
    padding: 0;
    overflow:auto; 
}

.rgt_search {
	width: 20px;
	height: 20px;
	float: right;
	margin-right: 16px;
	margin-top: 12px;
	background-size: 100% 100%;
	background-image: url("img/search.png");
}
    
.div_fullscreen{       
    z-index:9998;background-color:rgba(244,244,244,1);width:100%;height:100%;position: fixed;top:0px;
}

 .head_div{
	text-align:center;
	border-radius: 2px;
	font-size:18px;
	font-weight:bold;
	background:rgba(235,236,237,0.5);
	height:35px;
	line-height:35px;
	margin-top:5px;
	margin-left:60px;
	padding-left:5px;
}



.mui-input-row input{
	
	font-size:1em;

}
.mui-input-row label{
	
	color:#666666;
	font-size:1em;
	padding-right:15vw;
	
}

.mui-col-xs-6 .mui-input-row label{
	padding-top:4vw;
	padding-right:2px;
	width:20vw;
	
	font-size:0.9em;
	color:#666666;
	
}
.mui-col-xs-6 .mui-input-row input{
	padding-top:3vw;
	width:30vw;
	font-size:0.9em;
	
}
/*移动设备无效-真特么无语，label内容两端对齐 
label {
	text-align:justify;
	text-justify:distribute-all-lines;//ie6-8
	text-align-last:justify;// ie9
	-moz-text-align-last:justify;//ff
	-webkit-text-align-last:justify;//chrome 20+
}
 @media screen and (-webkit-min-device-pixel-ratio:0){//chrome
	label:after{
	    content:".";
	    display: inline-block;
	    width:100%;
	    overflow:hidden;
	    height:0;
	}
} */

input .money{
	text-align:right;
	color:#f78143;
}
input .money{
	text-align:right;
	color:#fe524e;
}

.Max_msg{
    float:right;
}
</style>
 		<script>
			var thisURL; 
			var fileno;
			var pawn_no;
			var user_type;//用户级别
			var login_user;//当前用户
			var edit_flag = '1';//是否可以编辑标志 0-不可编辑 1-可编辑
			var pawn_flag;
			$(function() {				

 				mui.init({
					swipeBack:true //启用右滑关闭功能
				});
 				
				mui('.mui-scroll-wrapper').scroll({
	                deceleration: 0.0005 //flick 减速系数，系数越大，滚动速度越慢，滚动距离越小，默认值0.0006
	            });
				
				mui(document.body).on('tap', '.mui-action-back ', function(e) {
					this.click();
					return false;
				});
				
				mui(document.body).on('tap', '.mui-table-view .mui-table-view-cell ', function(e) {
					this.click();
					return false;
				}); 
				top.edit_flag='1';
            	initPage();
			});  
			
			function initPage(){
				thisURL = document.URL; 
				var getenv = thisURL.split("?")[1];
				
				var buf= getenv.split("&"); 
				fileno = buf[0].split("=")[1];
				pawn_flag = buf[1].split("=")[1];
				var data = {};
				data.fileno = fileno;
				data.flag = pawn_flag;
				
				top.http_comm("6086", data, doAfterInit);
				
				login_user = localStorage.getItem("user_id");
				user_type = localStorage.getItem("user_type");
				
			}
			
			function doAfterInit(msg){
				var msg = typeof msg == 'object' ? msg : JSON.parse(msg);
				
				
				if(msg.data.ret_code == "0000"){
					top.writelog("sucess");
					//上传成功后显示检查按钮
					$("#btn_begin_check").show();
					
					//抵押物唯一编号
					pawn_no = msg.data.pawn_number;
					var responseData = msg.data;
					 for(var key in responseData){
						if(key == 'assess_data'){ //评估数据 第一条是国佳的 第二条是世联的
							var assess_gj = responseData.assess_data[0];
						
							$("#unit_price_gj").val(assess_gj.unit_price);
							$("#total_price_gj").val(assess_gj.total_price);
							$("#evaluate_time_gj").val(assess_gj.evaluate_time);
					
							
							var assess_sl = responseData.assess_data[1];
							 $("#unit_price_sl").val(assess_sl.unit_price);
							 $("#total_price_sl").val(assess_sl.total_price);
							 $("#evaluate_time_sl").val(assess_sl.evaluate_time);
				
						}else{
							if($("#"+key).length > 0){
				        		top.writelog("6086:key="+key+";value="+responseData[key]);
				        		//选择项，需要根据代码做转换				                
				    	        $("#"+key).val(responseData[key]);
				        	}
						}
			        	
			        }
					 var pawn_data = {};
					 pawn_data.fileno = msg.data.fileno;
					 pawn_data.pawn_images = msg.data.pawn_images;
					 pawn_data.pawn_des = msg.data.pawn_des;
					 pawn_data.note = msg.data.note;
					 
					 localStorage.setItem(pawn_data.fileno+"_pawndata", JSON.stringify(pawn_data));
					 
					 //如果不是本人，就只能是管理员了
					 if((msg.data.user_id.toLowerCase()) != (login_user.toLowerCase())){
						 if(msg.data.stat == '3' || msg.data.stat == '2'){//已完成或已驳回
							
								$("input").attr("readonly", "readonly");
								$(".btn_class").hide();
								$("#back_div").show();
								$("#back_div textarea").attr("readonly", "readonly");
								$("#btn_query_check").show();
						 }else{
							 $(".mui-pull-right").show();
								$("input").attr("readonly", "readonly");
								$(".btn_class").hide();
								$("#back_div").show();
								$("#btn_query_check").show();
						 }
						
						
						edit_flag = '0';
					 }else{
						 if(msg.data.stat == '3'){ //已经完成得只能查看
							 $("input").attr("readonly", "readonly");
							 $("textarea").attr("readonly", "readonly");
							 $("#con_div").show(); 
							 edit_flag = '0';
							 $("#btn_query_check").show();
							// $("#btn_back_check").show();
						 }else if(msg.data.stat == '2'){//被驳回了，可以修改，但是不能最终确认
							$("#back_div").show();
							$("#back_div textarea").attr("readonly", "readonly");
							$("#btn_query_check").show();
							$("#btn_update").show();
							edit_flag = '1';
						 }else{ //已确认
							$("#btn_query_check").show();
							$("#btn_update").show();
							$("#btn_back_check").show();
							edit_flag = '1';
							$("#con_div").show(); 
						 }
						
							
						
					 }
				}else{
					top.writelog("error");
					mui.alert("查询失败，请检查网络情况或联系系统管理员", "风险管理系统", null);
				}
			}

			
			//获取评估信息后，显示评估板块，并且移动屏幕
			function move_to_result(){
				$("#assess_result").show();
				mui('.mui-scroll-wrapper').scroll().reLayout();//重新布局，不加这个移动后会自动回弹
      			mui('.mui-scroll-wrapper').scroll().scrollTo(0,y,1000);//1000毫秒滚动顶部滚动到Y的位置
			}
			
			
			function search_show(){
				if(top.isEmpty(area_no_s)){
					mui.alert("请先选择抵押物所在区域", "风险管理系统", null);
					return;
				}
				if(top.isEmpty($("#user_name").val())){
					mui.alert("请先填写客户名称", "风险管理系统", null);
					return;
				}
				$(".div_fullscreen").show();
				$('#search_key').focus();
			}
			function search_hide(){
				$(".div_fullscreen").hide();
				$('#search_key').blur();
			}
			
			//跟新评估信息
			function upload_pawn_info(){
				if(top.isEmpty($("#final_assess").val())){
					mui.alert("最终估价必须填写", "风险管理系统", null);
					return;
				}
				
				var data={};
				data.user_name = $("#user_name").val();
				data.address = $("#address").val();
				data.final_assess = $("#final_assess").val();
				data.user_id = localStorage.getItem("user_id");
				data.pawn_number = pawn_no;
				data.fileno = fileno;
				data.pawn_flag = pawn_flag;
				top.writelog("upload data="+JSON.stringify(data));
				$("#btn_begin_check").show();//for test
				$("#btn_update").attr("background", "#cccccc");
				
				top.http_comm("6081", data, doAfterUpload);
			}
			
			function doAfterUpload(msg){
				var msg = typeof msg == 'object' ? msg : JSON.parse(msg);
				
				if(msg.data.ret_code == "0000"){
					mui.alert("修改成功", "风险管理系统", null);
				}else{
					mui.alert("查询失败，请检查网络情况或联系系统管理员", "风险管理系统", null);
				}
			}
			
			function query_check(){
				//	showNewFrame('survey_house_check.html?pawn_no='+pawn_no+'&edit_flag='+edit_flag, 'smask');
				showNewFrame('survey_house_check.html?fileno='+fileno+'&edit_flag='+edit_flag+'&pawn_flag='+pawn_flag, 'smask');
			}
			
			//多行文本输入框剩余字数计算
            function checkMaxInput(obj, maxLen) {
                if (obj == null || obj == undefined || obj == "") {
                    return;
                }
                if (maxLen == null || maxLen == undefined || maxLen == "") {
                    maxLen = 100;
                }
                
                var strResult;
                var $obj = $(obj);
                var newid = $obj.attr("id") + 'msg';
                
                if (obj.value.length > maxLen) { //如果输入的字数超过了限制
                    obj.value = obj.value.substring(0, maxLen); //就去掉多余的字
                    strResult = '<span id="' + newid + '" class=\'Max_msg\' >剩(' + (maxLen - obj.value.length) + ')字</span>'; //计算并显示剩余字数
                }
                else {
                    strResult = '<span id="' + newid + '" class=\'Max_msg\' >剩(' + (maxLen - obj.value.length) + ')字</span>'; //计算并显示剩余字数
                }
                
                var $msg = $("#" + newid);
                if ($msg.length == 0) {
                    $obj.after(strResult);
                }
                else {
                    $msg.html(strResult);
                }
            }
          //客户经理确认检查
			function conclusion_check(){
				//驳回理由不能为空
				if(top.isEmpty($("#conclusion").val())){
					mui.alert("驳回理由不能为空", "风险管理系统", null);
					return;
				}
				var data={};
				data.fileno = fileno;
				data.conclusion = $("#conclusion").val();
				data.flag = '1';
				top.http_comm("6087", data, doAfterReject);
				
			}
			
			//客户经理确认检查处理函数
			function doAfterReject(msg){
				var msg = typeof msg == 'object' ? msg : JSON.parse(msg);
				
				if(msg.data.ret_code == "0000"){
					mui.alert("处理成功,点击确认返回上一页面", "风险管理系统", function(){
						
						//退回父页面 
						back_history();
						//刷新父页面
						parent.refresh();
					});
					
				}else{
					mui.alert("处理失败", "风险管理系统", null);
				}
				
			}
			
			//管理员驳回检查
			function reject_check(){
				//驳回理由不能为空
				if(top.isEmpty($("#reject_note").val())){
					mui.alert("驳回理由不能为空", "风险管理系统", null);
					return;
				}
				var data={};
				data.fileno = fileno;
				data.reject_note = $("#reject_note").val();
				data.flag = '1';
				top.http_comm("6093", data, doAfterReject);
				
			}
			
			//驳回后处理函数
			function doAfterReject(msg){
				var msg = typeof msg == 'object' ? msg : JSON.parse(msg);
				
				if(msg.data.ret_code == "0000"){
					mui.alert("处理成功,点击确认返回上一页面", "风险管理系统", function(){
						
						//退回父页面 
						back_history();
						//刷新父页面
						parent.refresh();
					});
					
					
				}else{
					mui.alert("处理失败", "风险管理系统", null);
				}
				
			}
			 //清空剩除字数提醒信息
	        function resetMaxmsg() {
	            $('.Max_msg').hide();
	        }
		</script>
    </head>
    
<body>
		<header class="mui-bar mui-bar-nav head_color">
			<a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left" onclick="back_history();" ></a>
			<h1 class="mui-title">现场勘察-住宅</h1>
			<a  class="mui-icon mui-icon-undo mui-pull-right"  style="display:none" onclick="reject_check();"><font style="font-size:0.8em;">驳回</font></a>
		</header>



       <div class="mui-content mui-scroll-wrapper">
       		<div class="mui-scroll" >
       

               <div class="mui-content" style="margin-top:26px;">
					<form class="mui-input-group">
						<div class="mui-input-row">
							<label>客户名称</label>
							<input type="text" placeholder="输入客户名称（全称）" id="user_name">
						</div>
						<div class="mui-input-row">
							<label>押品区域</label>
							<input type="text" placeholder="点击选择抵押物区域" id="area_no" readonly="readonly">
						</div>
						<div class="mui-input-row">
							<label>押品坐落</label>
							<input type="text" placeholder="请输入具体地址" id="address" readonly="readonly">
						</div>
						<div class="mui-input-row" onclick="search_show();">
							<label>小区名称</label>
							<input type="text" placeholder="点击搜索小区信息" id="estate_name" readonly="readonly">
						</div>
				
						<!-- 栏栅布局 -->
						<div class="mui-row">
							<div class="mui-col-xs-6">
								<div class="mui-input-row">
									<label>面积</label>									
									<input data-role="none" type="number"   placeholder="房产面积"
											id="area" maxlength='5' style="width:45%;float:left;"/>
											<span style="font-size: 0.8em;color: #8e8e8e;">m²</span>
								</div>
							</div>
							<div class="mui-col-xs-6">
								<div class="mui-input-row">
									<label>楼栋号</label>
									<input type="number" placeholder="楼栋号" id="building_number">
								</div>
							</div>
							<div class="mui-col-xs-6">
								<div class="mui-input-row">
								<label>单元号</label>
								<input type="number" placeholder="单元号" id="unit_number">
								</div>
							</div>
							<div class="mui-col-xs-6">
								<div class="mui-input-row">
								<label>房间号</label>
								<input type="number" placeholder="房间号" id="room_number">
								</div>
							</div>
							
							
							<div class="mui-col-xs-6">
								<div class="mui-input-row">
									<label>楼层</label>
									<input type="number" placeholder="房屋楼层" id="floor">
								</div>
							</div>
							<div class="mui-col-xs-6">
								<div class="mui-input-row">
								<label>总楼层</label>
								<input type="number" placeholder="总楼层" id="total_floor">
								</div>
							</div>
							
						</div>
					</form>
				</div>
            	<div class="mui-content assess_result" style="margin-top:10px;">
            	
	            	<form class="mui-input-group" style="padding-top:10px;">
	            		<h3 style="text-indent:1em;color:#e95555;">估价信息</h3>
	            		<div class="mui-input-row">
							<label>最终估价</label>
							<input type="number" placeholder="输入最终估价" class="final" style="width:55%;float:left;"  id="final_assess">
							<span style="font-size: 0.9em;color: #8e8e8e;line-height:40px;">万</span>
						</div>
						<div class="mui-input-row">
							<label>最高限价</label>
							<input type="text" placeholder="最高限价" class="money" id="limit_price" style="width:55%;float:left;">
							<span style="font-size:0.8em;color: #8e8e8e;line-height:40px;">元/m²</span>
						</div>
					</form>
					<form class="mui-input-group" style="padding-top:10px;">
						<h5 style="text-indent:1em;color:#f78143;">国佳评估信息</h5>
						<div class="mui-input-row">
							<label>总价</label>
							<input data-role="none" type="number"  class="money" style="width:55%;float:left;" placeholder="评估总价-国佳"
										id="total_price_gj" maxlength='5'/><span style="font-size: 0.9em;color: #8e8e8e;line-height:40px;">万</span>
						</div>
						<div class="mui-input-row">
							<label>单价</label>
							<input data-role="none" type="number" class="money" style="width:55%;float:left;" placeholder="评估单价-国佳"
										id="unit_price_gj" maxlength='5'/><span style="font-size: 0.8em;color: #8e8e8e;line-height:40px;">元/m²</span>
						</div>
						<div class="mui-input-row">
							<label>评估时间</label>
							<input type="text" placeholder="评估时间-国佳" id="evaluate_time_gj">
						</div>
						
					</form>
					<form class="mui-input-group" style="padding-top:10px;">
						<h5 style="text-indent:1em;color:#fe524e;">世联评估信息</h5>
						<div class="mui-input-row">
							<label>总价</label>
							<input data-role="none" type="number"  class="money" style="width:55%;float:left;" placeholder="评估总价-世联"
										id="total_price_sl" maxlength='5'/><span style="font-size: 0.9em;color: #8e8e8e;line-height:40px;">万</span>
						</div>
						<div class="mui-input-row">
							<label>单价</label>
							<input data-role="none" type="number"  class="money" style="width:55%;float:left;" placeholder="评估单价-世联"
										id="unit_price_sl" maxlength='5'/><span style="font-size: 0.9em;color: #8e8e8e;line-height:40px;">元/m²</span>
						</div>
						<div class="mui-input-row">
							<label>评估时间</label>
							<input type="text" placeholder="评估时间-世联" id="evaluate_time_sl">
						</div>
					</form>
					
  				</div>
  		
			
				<div class="mui-content-padded" style="margin: 5px;display:none" id="con_div">
	                <form class="mui-input-group" >
	                	<h5 style="text-indent:1em;color:#fe524e;">特殊事项说明</h5>
	                    <div class="mui-input-row" style="height:105px;">
	                        <textarea id="conclusion" rows="4" placeholder="特殊事项说明（500字以内）" maxlength='500' onkeydown="checkMaxInput(this,500)"
	                            onkeyup="checkMaxInput(this,500)" onfocus="checkMaxInput(this,500)" onblur="checkMaxInput(this,500);resetMaxmsg()"></textarea>
	                    </div>
	                </form>
	            </div>
	            <div class="mui-content-padded" style="margin: 5px;display:none" id="back_div">
	                <form class="mui-input-group" >
	                	<h5 style="text-indent:1em;color:#fe524e;">驳回理由</h5>
	                    <div class="mui-input-row" style="height:105px;">
	                        <textarea id="reject_note" rows="4" placeholder="驳回理由，注意事项（500字以内）" maxlength='500' onkeydown="checkMaxInput(this,500)"
	                            onkeyup="checkMaxInput(this,500)" onfocus="checkMaxInput(this,500)" onblur="checkMaxInput(this,500);resetMaxmsg()"></textarea>
	                    </div>
	                </form>
	            </div>
				<div style="margin-top:30px;text-align:center;display:block;" class="btn_class" id="btn_update">
	                <button type="button" class="mui-btn  mui-btn-primary" style="width:90%" onclick="upload_pawn_info();">修改评估信息</button>
	            </div>
	    
	            <div style="margin-top:30px;text-align:center;display:block;"  class="btn_class" id="btn_query_check">
	                <button type="button" class="mui-btn  mui-btn-primary" style="width:90%" onclick="query_check();">查看勘察信息</button>
	            </div>
	          
	            <div style="margin-top:30px;margin-bottom:100px;text-align:center;display:block;" class="btn_class" id="btn_back_check">
	                <button type="button" class="mui-btn  mui-btn-primary" style="width:90%" onclick="conclusion_check();">最终确认</button>
	            </div>
			
	            
<!-- 	            <div style="margin-top:10px;text-align:center;margin-bottom: 100px;display:none;" id="btn_summit_assess">
	                <button type="button" class="mui-btn  mui-btn-primary" style="width:90%" id="promptBtn">提交评估报告</button>
	            </div> -->
			</div>
		</div>

  
	<div class="div_fullscreen" style="display:none">
	    <div class="mui-content" >
	    	<div class="mui-scroll-wrapper">
		        <div class="mui-scroll">
		            <div style="margin-top:25px;padding:10px;" >
		                <input type="search" class="mui-input-clear"   id="search_key"  placeholder="按关键字搜索问题" style="width:85%;float:left;">
		                    <div style="width:15%;float:right;padding-left:5px;"><button type="button" class="mui-btn  mui-btn-primary"  onclick="search_hide()">取消</button></div>
		                    </div>
		           
		                    <ul class="mui-table-view" style="margin-top:45px;" id="context">
		                        
		                    </ul>
		        </div>
	        </div>
	    </div>
     </div> 

<script src="hello-mui/js/mui.min.js"></script>
		
		<script src="hello-mui/js/mui.picker.js"></script>
		<script src="hello-mui/js/mui.poppicker.js"></script>
		<script src="hello-mui/js/city.data.js" type="text/javascript" charset="utf-8"></script>
		<script src="hello-mui/js/city.data-3.js" type="text/javascript" charset="utf-8"></script>
		<script>
  			(function($, doc) {
				$.init();
				$.ready(function() {
					//三级联示例 抵押物地址
					var cityPicker3 = new $.PopPicker({
						layer: 3
					});
					cityPicker3.setData(cityData3);
					cityPicker3.pickers[0].setSelectedIndex(16);//默认湖北
						
					cityPicker3.pickers[1].setSelectedValue(1);//默认武汉
					
					
					var area_no = doc.getElementById('area_no');
					area_no.addEventListener('tap', function(event) {
						cityPicker3.show(function(items) {
							area_no.value = (items[0] || {}).text + " " + (items[1] || {}).text + " " + (items[2] || {}).text;
							//返回 false 可以阻止选择框的关闭
							//return false;
						//	area_no = (items[0] || {}).value + "-" + (items[1] || {}).value + "-" + (items[2] || {}).value;
							area_no_s = (items[2] || {}).value;
							
							
							
							
						});
					}, false);
				});
			})(mui, document);   
		</script>

    </body>
</html>
