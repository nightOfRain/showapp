<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title></title>
<link href="js/lib/bootstrap3.0/bootstrap.css" rel="stylesheet">		
<link href="css/lib/zzlcss/menu11.css" rel="stylesheet">  
<link rel="stylesheet" href="css/common.css">
<link rel="stylesheet" type="text/css" href="css/aui/aui.css" />
<link rel="stylesheet" href="css/iconfont.css">
<link rel="stylesheet" href="hello-mui/css/mui.min.css">
<link rel="stylesheet" href="hello-mui/css/app.css">
<link rel="stylesheet" href="css/frozen.css">
<link rel="stylesheet" href="css/demo.css">
<script src="hello-mui/js/mui.min.js"></script>
<script type="text/javascript" src="js/lib/jQuery/jquery-2.0.0.min.js"></script>
<script type="text/javascript" src="js/lib/bootstrap3.0/bootstrap.min.js"></script>
<script type="text/javascript" src="js/lib/zzljs/menu11_com.js"></script>
<script src="lib/zepto.min.js"></script>
<script src="js/frozen.js"></script>
<script src="js/index.js" type="text/javascript" charset="utf-8"></script>
<style>
        
html, body {
    position: relative;
    height: 100%;
}
body {
    background: #fff;
    font-family: Helvetica Neue, Helvetica, Arial, sans-serif;
    font-size: 14px;
    color:#000;
    margin: 0;
    padding: 0;
}
    
.img_lit{
             
    width: 80px;
   	height: 80px;
    
}
.divcss5_w{ border:0px solid #000; width:90px; height:85px;overflow:hidden;padding:5px;} 
.divcss5_w img{max-width:80px;_width:expression(this.width > 80 ? "80px" : this.width);}
.divcss5_h{ border:0px solid #000; width:85px; height:90px;overflow:hidden;padding:5px;} 
.divcss5_h img{max-height:80px;_height:expression(this.height > 80 ? "80px" : this.height);} 
</style>
<script type="text/javascript">

	var fileno;
	var myArray= new Array();
	var line_flag;
	var debt_flag=0;
      var count = 0;
       var file_path;
$(function() {

	//调整map高度
	var thisURL = document.URL; 
		localStorage.setItem("thisURL", thisURL);
	localStorage.setItem("thisURL", thisURL);
	fileno = localStorage.getItem("fileno");
			count = 0;
        file_path = localStorage.getItem("group_code");
	$("#check_date").val(get_date());
	//初始化多维数组
	for(var i = 0; i < 5; i++){
		myArray[i] = new Array();
	}
	
	initPage();
    mui.init({
    	swipeBack:true //启用右滑关闭功能
    });
    mui('.mui-scroll-wrapper').scroll({
    	deceleration: 0.0005 //flick 减速系数，系数越大，滚动速度越慢，滚动距离越小，默认值0.0006
    });
    mui(document.body).on('tap', '.mui-action-back ', function(e) {
		this.click();
		return false;
	});
});

function initPage(){
	if(top.data.check_step_three){

  			
		var data = top.data.check_step_three;
		debt_flag = data.debt_flag;
  			
  			$("#check_date").val(data.check_date);
  			
  			$("#sales").val(data.sales);
  			
  			$("#margin").val(data.margin);
  			
  			$("#debt").val(data.debt);
  			
  			$("#jbrly").val(data.note);
  		 
  			 
  			myArray[1] = data.balance_img.split('|');
  			myArray[3] = data.cash_img.split('|');
  			myArray[2] = data.margin_img.split('|');
  			myArray[4] = data.remarks_img.split('|');
  	
  			var file_path = localStorage.getItem("group_code");
  			for(var i = 1; i < 5; i++){
  				for(var j = 0; j < myArray[i].length; j++){
  					if(myArray[i][j].length > 0){
  						var imgurl =  top.imgpath+file_path+'/'+myArray[i][j];
      					add_pic_init(imgurl, i);
  					}else{
  						myArray[i].splice(j,1);
  					}
  					
  				}
  			}
  			
	}
}
function add_pic_init(server_url, num){
	
	
	//num++;
	var gallery = document.getElementById('gallery_'+num);
		
	var figure = document.createElement("figure");
	figure.setAttribute("class", "aui-col-xs-3");
	
	var div = document.createElement("div");
	div.setAttribute("class", "divcss5");


	var img = document.createElement("img");
	img.src = server_url;
         
          checkPicurl(server_url);
          var figcaption = document.createElement("figcaption");
          img.setAttribute("onclick", "show_photo('"+count+"','"+num+"')");
          
          count++;
	
	div.appendChild(img);
	
	figure.appendChild(div);
	figure.appendChild(figcaption)
    gallery.appendChild(figure);
	


					
}
function pz(flag){
	line_flag = flag;
          top.capturePhoto();		
      }
function add_pic(local_url, server_url){
	//为对应数组添加元素
	myArray[line_flag].push(server_url);
	
	var gallery = document.getElementById('gallery_'+line_flag);
	
	var figure = document.createElement("figure");
	figure.setAttribute("class", "aui-col-xs-3");
	
	var div = document.createElement("div");
	div.setAttribute("class", "divcss5");

	
	var img = document.createElement("img");
	img.src = local_url;
          var imgurl = top.imgpath+file_path+"/" + server_url;
          checkPicurl(imgurl);
          var figcaption = document.createElement("figcaption");
          img.setAttribute("onclick", "show_photo('"+count+"','"+line_flag+"')");
          
          count++;

	div.appendChild(img);
	
	figure.appendChild(div);
	figure.appendChild(figcaption)
    gallery.appendChild(figure);
					
}
function upload_info(){
	
	if(myArray[1].length == 0 || myArray[2].length == 0){
		top.alertInfo("资产负债表和利润表必须录入");
		return;
	}
	if( $("#sales").val().length == 0 ){
		top.alertInfo("销售额必须录入");
		return;
	}
	if( $("#margin").val().length == 0 ){
		top.alertInfo("净利润必须录入");
		return;
	}
	
	var notes = $("#jbrly").val();
	if(notes.length < 9){
		top.alertInfo("备注信息不得少于10字");
		return;
	}
	var data = {
      			fileno : fileno,
      			check_date : $("#check_date").val(),
      			sales : $("#sales").val(),
      			margin : $("#margin").val(),
      			debt : $("#debt").val(),
      			debt_flag : debt_flag,
      			balance_img : myArray[1].join('|'),
      			cash_img : myArray[3].join('|'),
      			margin_img : myArray[2].join('|'),
      			remarks_img : myArray[4].join('|'),
      			note:$("#jbrly").val(),
      			coordinate:top.coordinate,
      			address:top.address_gps,
      			trandate:get_trandate()
      		};
//	alert(JSON.stringify(data));
	Http_ajax(function(msg){
		top.stop_process();
	
		var json = eval("("+msg+")");
		if(json.data.retcode == 0){
			top.alertInfo(json.data.retinfo);		
			top.data.check_step_three = data;
			back_history();
			parent.update_button('3');
			return;
		}else{
			top.alertInfo(json.retinfo);
		}
		
	}, "app/6006", data);
	
       
}

function goto_debt(){
	var debt = $("#debt").val()
	showNewFrame('debt_info.html?debt='+debt, 'smask')
}
function checkPicurl(url){
    
    var img = new Image();
    img.src = url;
    img.onerror = function(){
        top.writelog(url+" 图片加载失败，请检查url是否正确");
        return false;
    };
    
    if(img.complete){
        top.writelog("complete[url]="+url+":"+img.width+","+img.height);
        localStorage.setItem(url, img.width+","+img.height)
    }else{
        img.onload = function(){
            top.writelog("onload[url]="+url+":"+img.width+","+img.height);
            localStorage.setItem(url, img.width+","+img.height);
            
            img.onload=null;//避免重复加载
        }
    }
    
}
function show_photo(index, num){
    top.items_curr = [];
    top.writelog("index="+index+";num="+num);
    for(var i = 0; i < myArray[num].length; i++){
        
        var imgurl = top.imgpath+file_path+"/" + myArray[num][i];
        
        var size = localStorage.getItem(imgurl);
        var width = size.split(',')[0];
        var height = size.split(',')[1];
        top.writelog("i="+i+";url="+imgurl+"[size]="+size);
        var item = {
            src: imgurl,
            w: parseInt(width, 10),
            h: parseInt(height, 10)
        };
        item.title = "财务数据检查";
        top.items_curr.push(item);
    }
    showNewFrame('showimage.html?index='+index+'&num='+num, 'smask');
}
function updateItem(num, ind){
    myArray[num].splice(ind, 1);
    top.writelog("ind="+ind+"after delete:"+myArray[num]);
    /*
    var gallery = document.getElementById('gallery_'+num);
    var list = gallery.document.getElementsByTagName('figure');
    
    gallery.removeChild(list[ind]);
     */
    $("#gallery_"+num+" figure").eq(ind).remove();
}
</script>
    </head>                                
	<body style="background-color: #f4f4f4;">
		<header class="mui-bar mui-bar-nav head_color">
			<a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left" onclick="back_history();" ></a>
			<h1 class="mui-title">财务数据检查</h1>
		</header>

        <div class="container-fluid">
            <div class="mui-content mui-scroll-wrapper">
                
                <div class="mui-scroll top_head">
		   	 	<section id="list" >
				    <div class="demo-item">
				        <div class="demo-block">
				        	<div class="ui-form ui-border-t">
				      		 	<div class="ui-form-item ui-form-item-l ui-border-b">
					                 <label class="ui-border-r">
					                           	 报表日期
					                 </label>
				                     <input type="date"  placeholder="请选择报表日期" id="check_date" />			                                            
				                </div>
				                <div class="ui-form-item ui-form-item-l ui-border-b">
					                 <label class="ui-border-r">
					                           	 销售额/万
					                 </label>
				                     <input type="text"  placeholder="请输入销售额，单位（万）" id="sales"/>			                                            
				                </div>
				                <div class="ui-form-item ui-form-item-l ui-border-b">
					                 <label class="ui-border-r">
					                           	净利润/万
					                 </label>
				                     <input type="text"  placeholder="请输入净利润，单位（万）" id="margin"/>			                                            
				                </div>
				                <div class="ui-form-item ui-form-item-l ui-border-b">
					                 <label class="ui-border-r">
					                           	负债额/万
					                 </label>
				                     <input type="text"  placeholder="请输入负债额，单位（万）" id="debt"/>			                                            
				                </div>
				                <div class="demo-block" id="div_query_back">
						            <ul class="ui-list ui-list-pure ui-border-b">
							            <li class="ui-border-t" onclick="goto_debt();">
							                <h2 class="ui-arrowlink"><span style="color:#00a5e0;font-size: 15px">详细债务人信息</span></h2>
							            </li>	
							             <li class="ui-border-t" onclick="showNewFrame('retal_info.html', 'smask')" id="ratal_info">
							                <h2 class="ui-arrowlink"><span style="color:#00a5e0;font-size: 15px">查看纳税信息</span></h2>
							            </li>				
						            </ul>
						        </div>
						      </div>
						  </div>
					</div>
				</section>
		      	<section class="ui-container" style="background-color: #ffffff;border-top: 1px solid #d0d0d0;">
					<section id="form">		        
				     	<div style="font-size: 15px;text-align: left;margin-top:10px;">
		                       <textarea style="width:90%;color:#5b5b5b;border:1px;background:#ffffff;margin-left: 15px;margin-right: 15px;" rows="4" id="jbrly" placeholder="这里填写备注信息,不得少于10字"></textarea>
		                </div>
		
						<div class="demo-item" >
		       				 <div class="demo-desc" style="text-align:center;font-size:18px;">（资产负债表、现金流量表、利润表、附注）其中资产负债表和利润表必须录入</div>
		       			</div>
					</section>
		
		        </section>
		        <div class="contain" style="margin: 0 0 0;background-color: #ffffff;border-bottom: 1px solid #d0d0d0;">
		        	<p style="padding-left:20px;">资产负债表</p>
							<ul style="width:100%;">
								<li style="display:inline-block;width:100%;">
				        			<!--data-pswp-uid 是每个gallery的id不能重复-->
							
									<div class="my-gallery" data-pswp-uid="1" style="width:100%;" id="gallery_1">	
																							
																									
									</div>	
									<div class="aui-col-xs-3"><div class="divcss5"><img src="img/add.png" onclick="pz('1');"/></div></div>											
								</li>
							</ul>
				</div>
				<div class="contain" style="margin: 0 0 0;background-color: #ffffff;border-bottom: 1px solid #d0d0d0;">
					<p style="padding-left:20px;">利润表</p>
							<ul style="width:100%;">
								<li style="display:inline-block;width:100%;">
				        			<!--data-pswp-uid 是每个gallery的id不能重复-->
							
									<div class="my-gallery" data-pswp-uid="2" style="width:100%;" id="gallery_2">	
																							
																									
									</div>	
									<div class="aui-col-xs-3"><div class="divcss5"><img src="img/add.png" onclick="pz('2');"/></div></div>											
								</li>
							</ul>
				</div>
				<div class="contain" style="margin: 0 0 0;background-color: #ffffff;border-bottom: 1px solid #d0d0d0;">
					<p style="padding-left:20px;">现金流量表</p>
							<ul style="width:100%;">
								<li style="display:inline-block;width:100%;">
				        			<!--data-pswp-uid 是每个gallery的id不能重复-->
							
									<div class="my-gallery" data-pswp-uid="3" style="width:100%;" id="gallery_3">	
																							
																									
									</div>	
									<div class="aui-col-xs-3"><div class="divcss5"><img src="img/add.png" onclick="pz('3');"/></div></div>											
								</li>
							</ul>
				</div>
				<div class="contain" style="margin: 0 0 0;background-color: #ffffff;border-bottom: 1px solid #d0d0d0;">
						<p style="padding-left:20px;">附注</p>
							<ul style="width:100%;">
								<li style="display:inline-block;width:100%;">
				        			<!--data-pswp-uid 是每个gallery的id不能重复-->
							
									<div class="my-gallery" data-pswp-uid="4" style="width:100%;" id="gallery_4">	
																							
																									
									</div>	
									<div class="aui-col-xs-3"><div class="divcss5"><img src="img/add.png" onclick="pz('4');"/></div></div>											
								</li>
							</ul>
				</div>
		      	   <section class="ui-container" >
					<section id="form">
						<div class="demo-item" >			       
					        <div class="demo-block"> 
					            <div class="ui-btn-wrap">
					            	
					                <button class="ui-btn-lg ui-btn-primary"  style="margin-top:20px;" onclick="upload_info()">
					                  	  保存
					                </button>
					            </div>
					
					        </div>
					    </div>
					   </section>
					  </section>  

		<div style="height:200px;"><p style="color:#f4f4f4">现场检查</p></div>
	</div>
</div>
</div>
</body>
	
</html>
