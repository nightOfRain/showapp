<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title></title>
<link href="js/lib/bootstrap3.0/bootstrap.css" rel="stylesheet">		
<link href="css/lib/zzlcss/menu11.css" rel="stylesheet">
<link href="css/common.css" rel="stylesheet">
    
<link rel="stylesheet" type="text/css" href="css/aui/aui.css" />
	
<link rel="stylesheet" href="css/iconfont.css">
<link rel="stylesheet prefetch" href="css/photoswipe.css">
<link rel="stylesheet prefetch" href="css/default-skin/default-skin.css">
<link rel="stylesheet" href="hello-mui/css/mui.min.css">
<link rel="stylesheet" href="hello-mui/css/app.css">
<link rel="stylesheet" href="css/frozen.css">
<link rel="stylesheet" href="css/demo.css">
<script src="hello-mui/js/mui.min.js"></script>
<script type="text/javascript" src="js/lib/jQuery/jquery-2.0.0.min.js"></script>
<script type="text/javascript" src="js/lib/bootstrap3.0/bootstrap.min.js"></script>
<script type="text/javascript" src="js/lib/zzljs/menu11_com.js"></script>


<script src="js/frozen.js"></script>
<script src="js/index.js" type="text/javascript" charset="utf-8"></script>
<style>
           
             html, body {
                 position: relative;
                 height: 100%;
             }
         body {
             background: #fff;
             font-family: Helvetica Neue, Helvetica, Arial, sans-serif;
             font-size: 14px;
             color:#000;
             margin: 0;
             padding: 0;
         }
       
        	.img_lit{
                      
                        width: 80px;
                       	height: 80px;
                        
                    }
         	.divcss5_w{ border:0px solid #000; width:90px; height:85px;overflow:hidden;padding:5px;} 
			.divcss5_w img{max-width:80px;_width:expression(this.width > 80 ? "80px" : this.width);}
			.divcss5_h{ border:0px solid #000; width:85px; height:90px;overflow:hidden;padding:5px;} 
			.divcss5_h img{max-height:80px;_height:expression(this.height > 80 ? "80px" : this.height);}
            input[type="date"]:before{
                color:#A9A9A9;
                content:attr(placeholder);
            }
        
        
        input[type="date"].full:before {
            color:black;
            content:""!important;
        }
        </style>
 		<script type="text/javascript">
 		var fileno;
 		var note_flag = 1;
 		var myArray = new Array();
        var count = 0;
        var file_path;
		$(function() {
			//调整map高度
			var thisURL = document.URL; 
				localStorage.setItem("thisURL", thisURL);
			localStorage.setItem("thisURL", thisURL);
			fileno = localStorage.getItem("fileno");
          count = 0;
          file_path = localStorage.getItem("group_code");
			//选择器控制
			$("input[name=radio]").click(function(){
				  showCont();
				 });
			
			initPage();
          mui.init({
                   swipeBack:true //启用右滑关闭功能
                   });
          mui('.mui-scroll-wrapper').scroll({
                                            deceleration: 0.0005 //flick 减速系数，系数越大，滚动速度越慢，滚动距离越小，默认值0.0006
                                            });
          
          mui(document.body).on('tap', '.mui-action-back ', function(e) {
				this.click();
                                return false;
			});
		});
		
		function initPage(){
			if(top.data.check_step_four){


    			
				var data = top.data.check_step_four;
				note_flag = data.retal_flag;
    			if(note_flag == 0){
    				$("#radio_0").attr("checked", true);
    				$("#note").hide();
    			}else{
    				$("#radio_1").attr("checked", true);
    			}
    			$("#sales_lastyear").val(data.sales_lastyear);
    			
    			$("#ratal_lastyear").val(data.ratal_lastyear);
    			
    			$("#sales_lastquarter").val(data.sales_lastquarter);
    			
    			$("#ratal_lastquarter").val(data.ratal_lastquarter);
    			$("#sales_now").val(data.sales_now);
    			$("#ratal_now").val(data.ratal_now);
    			$("#retal_note").val(data.retal_note);
    			
    		 
    			 
    			myArray = data.ratal_img.split('|');
    			
    	
				
    			var file_path = localStorage.getItem("group_code");
    				for(var j = 0; j < myArray.length; j++){
    					if(myArray[j].length > 0){
    						var imgurl =  top.imgpath+file_path+'/'+myArray[j];
        					add_pic_init(imgurl);
    					}else{
    						myArray.splice(j,1);
    					}
    					
    				}
    			
    			
			}else{
				$("#radio_1").attr("checked", true);
			}
		}
		function add_pic_init(server_url){
			
			
			
			var gallery = document.getElementById('gallery_2');
				
			var figure = document.createElement("figure");
			figure.setAttribute("class", "aui-col-xs-3");
			
			var div = document.createElement("div");
			div.setAttribute("class", "divcss5");
		
			
			var img = document.createElement("img");
			img.src = server_url;
            
            checkPicurl(server_url);
            var figcaption = document.createElement("figcaption");
            img.setAttribute("onclick", "show_photo('"+count+"','2')");
            
            count++;
			
			div.appendChild(img);
			
			figure.appendChild(div);
			figure.appendChild(figcaption)
		    gallery.appendChild(figure);
			

	
							
		}
		function showCont(){
			 switch($("input[name=radio]:checked").attr("id")){
			  case "radio_0":
			   	$("#note").hide();
			   	note_flag = 0;
			   break;
			  case "radio_1":
				  note_flag = 1;
				  $("#note").show();
			   break;
			  default:
			   break;
			 }
		}
		function pz(){
            
            top.capturePhoto(add_pic);

        }
		function add_pic(local_url, server_url){
			top.writelog("taxes_check add_pic local_url:"+local_url+",server_url:"+server_url);
			//添加照片到数组
			myArray.push(server_url);
			var gallery = document.getElementById('gallery_2');
			
			var figure = document.createElement("figure");
			figure.setAttribute("class", "aui-col-xs-3");
			
			var div = document.createElement("div");
			div.setAttribute("class", "divcss5");
		
			var a = document.createElement("a");
			a.setAttribute("href", local_url);
			var img = document.createElement("img");
			img.src = local_url;
            var imgurl = top.imgpath+file_path+"/" + server_url;
            checkPicurl(imgurl);
            var figcaption = document.createElement("figcaption");
            img.setAttribute("onclick", "show_photo('"+count+"','2')");
            
            count++;
			
			div.appendChild(img);
			
			figure.appendChild(div);
			figure.appendChild(figcaption)
		    gallery.appendChild(figure);
							
		}
		function upload_info(){

			if(myArray.length < 2){
				top.alertInfo("至少需要上传两张纳税申报检查图片");
				return;
			}
			var count = 0;
			$("input").each(function(){
				if($(this).val().length == 0){
					count++;
				}
			});
			if(note_flag == 1){
				var notes = $("#retal_note").val();
				
				if(notes.length < 9){
					top.alertInfo("备注信息不得少于10字");
					return;
				}
			}
			if(count > 0){
				top.alertInfo("上年度、上季度、本月当期的销售额及纳税额必须录入");
				return;
			}else{
				var data = {
	        			fileno : fileno,
	        			sales_lastyear : $("#sales_lastyear").val(),
	        			ratal_lastyear : $("#ratal_lastyear").val(),
	        			sales_lastquarter:$("#sales_lastquarter").val(),
	        			ratal_lastquarter:$("#ratal_lastquarter").val(),
	        			sales_now : $("#sales_now").val(),
	        			ratal_now : $("#ratal_now").val(),
	        			ratal_img : myArray.join('|'),
	        			retal_flag : note_flag,
	        			retal_note : $("#retal_note").val(),
	        			coordinate:top.coordinate,
	        			address:top.address_gps,
	        			trandate:get_trandate()
	        		};
			
			//	alert(JSON.stringify(data));
				Http_ajax(function(msg){
					top.stop_process();
					var json = eval("("+msg+")");
					if(json.data.retcode == 0){
						top.alertInfo(json.data.retinfo);		
						top.data.check_step_four = data;
						back_history();
						parent.update_button('4');
						return;
					}else{
						top.alertInfo(json.retinfo);
					}
				}, "app/6007", data);
			}
			
			
	       
		}
        function checkPicurl(url){
            
            var img = new Image();
            img.src = url;
            img.onerror = function(){
                top.writelog(url+" 图片加载失败，请检查url是否正确");
                return false;
            };
            
            if(img.complete){
                top.writelog("complete[url]="+url+":"+img.width+","+img.height);
                localStorage.setItem(url, img.width+","+img.height)
            }else{
                img.onload = function(){
                    top.writelog("onload[url]="+url+":"+img.width+","+img.height);
                    localStorage.setItem(url, img.width+","+img.height);
                    
                    img.onload=null;//避免重复加载
                }
            }
            
        }
        function show_photo(index, num){
            top.items_curr = [];
            top.writelog("index="+index+";num="+num);
            for(var i = 0; i < myArray.length; i++){
                
                var imgurl = top.imgpath+file_path+"/" + myArray[i];
                
                var size = localStorage.getItem(imgurl);
                var width = size.split(',')[0];
                var height = size.split(',')[1];
                top.writelog("i="+i+";url="+imgurl+"[size]="+size);
                var item = {
                    src: imgurl,
                    w: parseInt(width, 10),
                    h: parseInt(height, 10)
                };
                item.title = "纳税申报检查";
                top.items_curr.push(item);
            }
            showNewFrame('showimage.html?index='+index+'&num='+num, 'smask');
        }
        function updateItem(num, ind){
            myArray.splice(ind, 1);
            top.writelog("ind="+ind+"after delete:"+myArray);
            var gallery = document.getElementById('gallery_2');
            var list = document.getElementsByTagName('figure');
            
            gallery.removeChild(list[ind]);
        }
		</script>
    </head>                                
	<body style="background-color: #f4f4f4;">
	
		<header class="mui-bar mui-bar-nav head_color">
			<a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left" onclick="back_history();" ></a>
			<h1 class="mui-title">纳税申报检查</h1>
		</header>
	
        <div class="container-fluid" >
            <div class="mui-content mui-scroll-wrapper" >
                
                <div class="mui-scroll top_head">
					<div class="form_div_35">
						<p style="text-align:center;">请如实填写上年度、上季度、及本月当期销售额和纳税额。单位:万元</p>
						<ul>
							<li>
								<div class="aui-col-xs-4"><span>上年度</span></div><div class="aui-col-xs-4"><span>上季度</span></div><div class="aui-col-xs-4"><span>本月当期</span></div>
							</li>
							<li>
								<div class="aui-col-xs-4"><input width="100%" placeholder="销售额" id="sales_lastyear"/></div><div class="aui-col-xs-4"><input width="100%" placeholder="销售额" id="sales_lastquarter"/></div><div class="aui-col-xs-4"><input width="100%" placeholder="销售额"  id="sales_now"/></div>
							</li>
							<li>
								<div class="aui-col-xs-4"><input width="100%" placeholder="纳税额" id="ratal_lastyear"/></div><div class="aui-col-xs-4"><input width="100%" placeholder="纳税额" id="ratal_lastquarter"/></div><div class="aui-col-xs-4"><input width="100%" placeholder="纳税额" id="ratal_now"/></div>
							</li>
						</ul>
					</div>
			      	<section class="ui-container" style="background-color: #ffffff;border-top: 1px solid #d0d0d0;">
						<section id="form">
					        <div class="demo-item">				        
						        	<div class="demo-desc" style="margin-left: 10px;;font-size:18px;">检查财务报表与纳税申报是否有差异</div>
						        <div class="demo-block">
						        
						            <div class="ui-form ui-border-t">
						                <form action="#">
						                    <div class="ui-form-item ui-form-item-radio ui-border-b">				                        
						                        <label class="ui-radio" for="radio">
						                            <input type="radio" name="radio" checked="checked" id="radio_1" />
						                        </label>
						                        <p>是</p>
						                    </div>
						                    <div class="ui-form-item ui-form-item-radio ui-border-b">			                        
						                        <label class="ui-radio" for="radio">
						                            <input type="radio"  name="radio" id="radio_0"/>
						                        </label>
						                        <p>否</p>
						                    </div>
						                </form>
						            </div>
						        </div>
						    </div>
					     	<div style="font-size: 15px;text-align: left;margin-top:10px;" id="note">
			                       <textarea style="width:90%;color:#5b5b5b;border:1px;background:#ffffff;margin-left: 15px;margin-right: 15px;" rows="4" id="retal_note" placeholder="这里录入差异原因"></textarea>
			                </div>
						
					  
							<div class="demo-item" >
			       				 <div class="demo-desc" style="text-align:center;font-size:18px;">系统纳税申报核查拍照（至少2张照片）</div>
			       			</div>
			       			
						
			
						</section>
			
			        </section>
			        <div class="contain" style="margin: 0 0 0;background-color: #ffffff;border-bottom: 1px solid #d0d0d0;">
								<ul style="width:100%;">
									<li style="display:inline-block;width:100%;">
					        			<!--data-pswp-uid 是每个gallery的id不能重复-->
								
										<div class="my-gallery" data-pswp-uid="2" style="width:100%;" id="gallery_2">	
																								
																										
										</div>	
										<div class="aui-col-xs-3"><div class="divcss5"><img src="img/add.png" onclick="pz('1');"/></div></div>											
									</li>
								</ul>
					</div>

		      	   <section class="ui-container" >
						<section id="form">
							<div class="demo-item" >			       
						        <div class="demo-block"> 
						            <div class="ui-btn-wrap">
						            	
						                <button class="ui-btn-lg ui-btn-primary"  style="margin-top:20px;" onclick="upload_info()">
						                  	  保存
						                </button>
						            </div>
						
						        </div>
						    </div>
					   	</section>
					</section>  
	  
					<div style="height:200px;"><p style="color:#f4f4f4">现场检查</p></div>	
			</div>
		</div>
	</div>
</body>

</html>
