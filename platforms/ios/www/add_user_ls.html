<html>

<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title></title>
<link href="js/lib/bootstrap3.0/bootstrap.css" rel="stylesheet">
<link href="css/lib/zzlcss/menu11.css" rel="stylesheet">
<link rel="stylesheet" href="css/common.css">
<link rel="stylesheet" href="hello-mui/css/mui.min.css">

<!--App自定义的css-->
<link rel="stylesheet" type="text/css" href="hello-mui/css/app.css" />
<link rel="stylesheet" href="hello-mui/css/iconfont.css">
<link rel="stylesheet" href="hello-mui/css/demo.css">
<link href="hello-mui/css/mui.picker.css" rel="stylesheet" />
<link href="hello-mui/css/mui.poppicker.css" rel="stylesheet" />
<script src="hello-mui/js/iconfont.js"></script>
<script type="text/javascript" src="js/lib/jQuery/jquery-2.0.0.min.js"></script>
<script type="text/javascript" src="js/lib/bootstrap3.0/bootstrap.min.js"></script>

<script type="text/javascript" src="js/lib/zzljs/menu11_com.js"></script>
<script src="js/index.js" type="text/javascript" charset="utf-8"></script>
<style>
html, body {
    position: relative;
    height: 100%;
}
body {
    background: #fff;
    font-family: Helvetica Neue, Helvetica, Arial, sans-serif;
    font-size: 14px;
    color:#000;
    margin: 0;
    padding: 0;
    overflow:hidden;
    
}
.div_fullscreen_pg{
    
    z-index:9998;background-color:rgba(2,2,2,0.8);width:100%;height:100%;position: fixed;top:0px;
}

.div_process{
    
    z-index:9999;background-color:#FFFFFF; width:100%;position: fixed; bottom:0;left:0;text-align:left;
    
}
h5.mui-content-padded {
    margin-left: 3px;
    margin-top: 20px !important;
}
h5.mui-content-padded:first-child {
    margin-top: 12px !important;
}
.ui-alert {
    text-align: center;
    padding: 20px 10px;
    font-size: 16px;
}


.head_color{
    background-color: #18b4ed;
}
.mui-input-row input{
    font-size:15px;
   
}
.mui-input-row textarea{
    font-size:15px;
    
}
.mui-navigate-right{
	font-size:17px;
}

input[placeholder]{
	font-size:15px;
    
}
.icon {
	/* 通过设置 font-size 来改变图标大小 */
	width: 1.5em; height: 1.5em;
	/* 图标和文字相邻时，垂直对齐 */
	vertical-align: -0.35em;
	/* 通过设置 color 来改变 SVG 的颜色/fill */
	fill: currentColor;
	/* path 和 stroke 溢出 viewBox 部分在 IE 下会显示
	   normalize.css 中也包含这行 */
	overflow: hidden;
}
</style>
<script>
                                    
var thisURL;
var category_value = '0';
var guarant_type_value = '0';
var risk_type_value = '0';
var offline_flag = '0';//0-非离线数据，1-离线数据
$(function() {

    mui.init({
           swipeBack:true //启用右滑关闭功能
           });
    mui('.mui-scroll-wrapper').scroll({
                                    deceleration: 0.0005 //flick 减速系数，系数越大，滚动速度越慢，滚动距离越小，默认值0.0006
                                    });
    mui(document.body).on('tap', '.mui-action-back', function(e) {
                        this.click();
                        return false;
                        });
    top.edit_flag = 1;
    top.tmp_iframe = tmp_iframe; //把iframe页面赋值给全局变量，用于更新页面内容
    $('#search_key').bind('input propertychange', search_by_key);
    $("input [type=text]").attr("readonly", "readonly");
  });
  
//根据KEY查客户姓名
function search_by_key(){
	
	var key = $("#search_key").val();
	top.writelog("key="+key);
	
	if(key.length < 1)
		return;
	
	var data = {
			key:key,
            customer_type:'1',
			userid:localStorage.getItem("user_id")
	}
	top.writelog("6021 send:"+JSON.stringify(data));
	$.ajax({
        type : "post",
        timeout: 2000,
        url: "http://"+IP+":"+PORT+"/app/6021",			        
        data : data,
        datatype : "json",
        success : function(msg){
           	top.writelog("6021 recv:"+msg);
			var auto_html = '';
			$("#ul_key_list").html('');
			
			//先检查离线数据
			var offline_data = localStorage.getItem("add_offline_customer");
			top.writelog("offline_data="+offline_data);
			if(!top.isEmpty(offline_data)){ //如果有离线数据
				var offline_customer = JSON.parse(localStorage.getItem("add_offline_customer"));
				auto_html += '<li class="mui-table-view-cell" onclick="query_by_off()">'
	    		+'<a class="mui-navigate-right">'+offline_customer.customer+'<div class="rgt_l">离线存储，点击上传</div></a></li>'
			}
			
			var json = eval("("+msg+")");
			customer_list = json.data.list;
			
			if(json.data.list.length > 0){
				for(var i = 0; i < json.data.list.length; i++){
					
					auto_html += '<li class="mui-table-view-cell" onclick="query_by_id(\''+json.data.list[i].group_code+'\')">'
	                		+'<a class="mui-navigate-right">'+json.data.list[i].customer+'</a></li>'
				}
			}else{//新客户
				auto_html += '<li class="mui-table-view-cell" onclick="new_customer()">'
	    		+'<a class="mui-navigate-right">'+key+'<div class="rgt_l">新增客户，点击录入</div></a></li>'
	    
			}
				
			
			$("#ul_key_list").html(auto_html);
			
		},
        error:function(msg){
     	  
     	  // top.alertInfo('通讯失败，请稍后再试');
        }
        });
}  

function query_by_off(){
	var offline_customer = JSON.parse(localStorage.getItem("add_offline_customer"));
	offline_flag = '1';
	$("#tel_no").val(offline_customer.tel_no);
    $("#customer").val(offline_customer.customer);
    $("#group_code").val(json.data.customerinfo[0].group_code);
    $("#ls_address").val(offline_customer.ls_address);
    $("#risk_type").val(offline_customer.risk_type);
    $("#guarant_type").val(offline_customer.guarant_type);
    $("#guarantor").val(offline_customer.guarantor);
    $("#corporation").val(offline_customer.corporation);
    $("#category").val(offline_customer.category);
    $("#address").val(offline_customer.address);
    $(".div_fullscreen").hide();
}
function new_customer(){
	$("#customer").val($("#search_key").val());
	$(".div_fullscreen").hide();
}
//根据证件号码查客户信息
function query_by_id(qid){

  var data = {
      group_code:qid,
      user_id:localStorage.getItem("user_id"),
      customer_type:'1'
  };
  top.writelog("businesscheck="+JSON.stringify(data));
  
  Http_ajax(function(msg){
            top.writelog("6046="+msg);
            top.stop_process();
            
            var json = eval("("+msg+")");
            
            if(json.data.retcode == '2'){ //已录入过该客户信息
            	  localStorage.setItem("customer", json.data.customerinfo[0].customer);
            	  localStorage.setItem("group_code", json.data.customerinfo[0].group_code);
                $("#tel_no").val(json.data.customerinfo[0].tel_no);
                $("#customer").val(json.data.customerinfo[0].customer);
                $("#group_code").val(json.data.customerinfo[0].group_code);
                $("#ls_address").val(json.data.customerinfo[0].ls_address);
                $("#risk_type").val(json.data.customerinfo[0].risk_type);
                $("#guarant_type").val(json.data.customerinfo[0].guarant_type);
                $("#guarantor").val(json.data.customerinfo[0].guarantor);
                $("#corporation").val(json.data.customerinfo[0].corporation);
                $("#category").val(json.data.customerinfo[0].category);
                $("#address").val(json.data.customerinfo[0].address);
                $(".div_fullscreen").hide();
                offline_flag = '0';
                if(json.data.customerinfo[0].customer_state == '1'){
                   
                 
                    var btnArray = ['取消', '在线', '离线'];
                    mui.confirm('存量用户信息不可修改，是否现在开始检查？点击【在线】数据实时上传到服务器，点击【离线】数据暂时保存在本地。', '尽职调查新增用户', btnArray, function(e) {
                    	if (e.index == 1) { //在线
                    		showNewFrame('add_home.html', 'smask');
                    	}else if(e.index == 2){ //离线
                    		showNewFrame('add_offline_home.html', 'smask');
                    	}
 
                    });
                }else{
                 
                	var btnArray = ['取消', '在线', '离线'];
                    mui.confirm('新增客户，如果需要修改请点击【取消】，直接检查？点击【在线】数据实时上传到服务器，点击【离线】数据暂时保存在本地。', '尽职调查新增用户', btnArray, function(e) {
                    	if (e.index == 1) { //在线
                    		showNewFrame('add_home.html', 'smask');
                    	}else if(e.index == 2){ //离线
                    		showNewFrame('add_offline_home.html', 'smask');
                    	}
                    	
                    	
                    	
                    	
                    });
                }
                $("#ul_check").show();
            }
            
            
            }, "app/6046", data);

}	
//根据证件号码查客户信息
function query_by_no(){
  var qno = $("#group_code").val();
  
  var isCheck=IdentityCodeValid(qno);
  if(!isCheck){
     // top.alertInfo(isCheck);
      return;
  }
  var data = {
      group_code:qno,
      user_id:localStorage.getItem("user_id"),
      customer_type:'1'
  };
  top.writelog("businesscheck="+JSON.stringify(data));
  
  Http_ajax(function(msg){
            top.writelog("6046="+msg);
            top.stop_process();
            
            var json = eval("("+msg+")");
            
            if(json.data.retcode == '2'){ //已录入过该客户信息
              	localStorage.setItem("customer", json.data.customerinfo[0].customer);
              	localStorage.setItem("group_code", json.data.customerinfo[0].group_code);
                $("#tel_no").val(json.data.customerinfo[0].tel_no);
                $("#customer").val(json.data.customerinfo[0].customer);
                $("#group_code").val(json.data.customerinfo[0].group_code);
                $("#ls_address").val(json.data.customerinfo[0].ls_address);
                $("#risk_type").val(json.data.customerinfo[0].risk_type);
                $("#guarant_type").val(json.data.customerinfo[0].guarant_type);
                $("#guarantor").val(json.data.customerinfo[0].guarantor);
                $("#corporation").val(json.data.customerinfo[0].corporation);
                $("#category").val(json.data.customerinfo[0].category);
                $("#address").val(json.data.customerinfo[0].address);
                $(".div_fullscreen").hide();
                offline_flag = '0';
                if(json.data.customerinfo[0].customer_state == '1'){
                   
                   
                    var btnArray = ['取消', '在线', '离线'];
                    mui.confirm('存量用户信息不可修改，是否现在开始检查？点击【在线】数据实时上传到服务器，点击【离线】数据暂时保存在本地。', '尽职调查新增用户', btnArray, function(e) {
                    	if (e.index == 1) { //在线
                    		showNewFrame('add_home.html', 'smask');
                    	}else if(e.index == 2){ //离线
                    		showNewFrame('add_offline_home.html', 'smask');
                    	}
                    });
                    $("#ul_check").show();
                    
                }else{
                 
                    
                    var btnArray = ['取消', '在线', '离线'];
                    mui.confirm('改用户为新增客户，可以修改基本信息，若无需修改可以直接开始检查，点击【在线】数据实时上传到服务器，点击【离线】数据暂时保存在本地。', '尽职调查新增用户', btnArray, function(e) {
                    	if (e.index == 1) { //在线
                    		showNewFrame('add_home.html', 'smask');
                    	}else if(e.index == 2){ //离线
                    		showNewFrame('add_offline_home.html', 'smask');
                    	}
                    });
                    $("#ul_check").show();
                }
            }
            
            
            }, "app/6046", data);

}

function add_or_modify(){
    var qno = $("#group_code").val();
    var customer = $("#customer").val();
    localStorage.setItem("customer", customer);
    localStorage.setItem("group_code", qno);
    if(top.isEmpty(qno)){
        top.alertInfo("证件编号不能为空");
        return;
    }
    var isCheck=IdentityCodeValid(qno);
    if(!isCheck){
        top.alertInfo(isCheck);
        return;
    }
    if(top.isEmpty(customer)){
        top.alertInfo("客户姓名不能为空");
        return;
    }
    
    var data = {
        user_id:localStorage.getItem("user_id"),
        group_code:$("#group_code").val(),
        customer:$("#customer").val(),
        tel_no:$("#tel_no").val(),
        ls_address:$("#ls_address").val(),
        risk_type:$("#risk_type").val(),
        guarant_type:$("#guarant_type").val(),
        guarantor:$("#guarantor").val(),
        corporation:$("#corporation").val(),
        category:$("#category").val(),
        address:$("#address").val(),
        customer_type:'1'
    };
    top.writelog("6047 send="+JSON.stringify(data));

                    Http_ajax(function(msg){
                        top.writelog("6047="+msg);
                        top.stop_process();
                        
                        var json = eval("("+msg+")");
                        top.writelog("6047 recv:"+msg);
                        if(json.stat == '0'){ //保存成功
                        	if(offline_flag == '1'){//离线数据上传成功后操作
                        		offline_flag = '0';
                        		localStorage.removeItem('add_offline_customer');
                        	}
           
                            var btnArray = ['取消', '在线', '离线'];
                            mui.confirm('客户信息提交成功，是否现在开始检查？点击【在线】数据实时上传到服务器，点击【离线】数据暂时保存在本地。', '尽职调查新增用户', btnArray, function(e) {
                            	if (e.index == 1) { //在线
                            		showNewFrame('add_home.html', 'smask');
                            	}else if(e.index == 2){ //离线
                            		showNewFrame('add_offline_home.html', 'smask');
                            	}

                            });
                            $("#ul_check").show();
                            $("input").attr("readonly", "readonly");

                        }else{
                        		top.alertInfo("提交失败:"+json.data.retinfo);                        		
                        }

                        }, "app/6047", data);
   
}

function update_address(address){				
	top.address_gps = address;
	$("#address_gps").html(address);			
}

function show_customer(){
	$(".div_fullscreen").show();
	$("#search_key").focus();
}

function search_hide(){
	$(".div_fullscreen").hide();
	$("#search_key").val('');
	$("#tel_no").val('');
    $("#customer").val('');
    $("#ls_address").val('');
    $("#risk_type").val('');
    $("#guarant_type").val('');
    $("#guarantor").val('');
    $("#corporation").val('');
    $("#category").val('');
    $("#address").val('');
}
</script>
</head>
    <body>
        <header class="mui-bar mui-bar-nav head_color">
            <a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left" onclick="back_history();" ></a>
            <h1 class="mui-title">新增零售客户资料</h1>
            <a  class="mui-icon-location mui-icon  mui-pull-right"  onclick="showNewFrame('map.html', 'smask')"></a>
        </header>
        
       
        <div class="mui-content mui-scroll-wrapper" >
            <div class="mui-scroll" >
            <iframe style="width:100%;border:0;margin-top:25px;" src="map_header.html" mce_src="map_header.html" name="tmp_iframe" id="tmp_iframe"></iframe>
        
                <div id="qy_div" style="background-color: #efeff4;height:100%;margin-top:-25px;">
                    <div class="mui-content-padded" style="margin: 5px;">
                        <form class="mui-input-group">
                            <div class="mui-input-row">
                                <label>客户名称</label>
                                <input type="text" id="customer" placeholder="客户名称" onfocus="show_customer();">
                            </div>
                            <div class="mui-input-row">
                                <label>证件号码</label>
                                <input type="text" id="group_code" onblur="query_by_no()" placeholder="证件号码" maxlength='18'>
                            </div>
                            <div class="mui-input-row" >
                                <label>联系方式</label>
                                <input type="tel" id="tel_no" placeholder="联系方式" maxlength='11'>
                            </div>
                            <div class="mui-input-row">
                                <label>联系地址</label>
                                <input type="text" placeholder="输入具体地址" id="ls_address">
                            </div>
                        </form>
                    </div>
                    <div class="mui-content-padded" style="margin: 5px;">
                        <form class="mui-input-group" >
                            <div class="mui-input-row">
                                <label>风险分类</label>
                                <input type="text" placeholder="点击选择风险分类" id="risk_type">
                            </div>
                            <div class="mui-input-row">
                                <label>担保方式</label>
                                <input type="text" placeholder="点击选择担保方式" id="guarant_type">
                            </div>
                            <div class="mui-input-row">
                                <label>担保人</label>
                                <input type="text" placeholder="输入具体担保人" id="guarantor">
                            </div>
                        </form>
                    </div>
                    <div class="mui-content-padded" style="margin: 5px;">
                        <form class="mui-input-group" >
                            <div class="mui-input-row">
                                <label>经营实体名称</label>
                                <input type="text" placeholder="输入客户经营实体名称" id="corporation">
                            </div>
                            <div class="mui-input-row">
                                <label>行业分类</label>
                                <input type="text" placeholder="输入行业分类" id="category">
                                    </div>
                            <div class="mui-input-row">
                                <label>注册地址</label>
                                <input type="text" placeholder="输入注册地址" id="address">
                            </div>
                        </form>
                    </div>
                    <div style="margin-top:10px;text-align:center;margin-bottom: 30px;" id="save_button">
                        <button type="button" class="mui-btn  mui-btn-primary" style="width:90%" onclick="add_or_modify()">提交</button>
                    </div>
          			<ul class="mui-table-view mui-grid-view mui-grid-9" style="background:rgba(45,45,45,0.2);height:45px;border:0px;border-bottom: 0px solid #2d2d2d;display:none;" id="ul_check">
			            <li class="mui-table-view-cell  mui-col-xs-6" onClick="showNewFrame('add_home.html', 'smask');">
			                   <svg class="icon" aria-hidden="true">
			                        <use xlink:href="#icon-mendianchaxun"></use>
			                    </svg> 
			                   	 在线检查
			              
			             </li>
			             <li class="mui-table-view-cell  mui-col-xs-6" onClick="showNewFrame('add_offline_home.html', 'smask');">
			                   <svg class="icon" aria-hidden="true">
			                        <use xlink:href="#icon-fangyuanchaxun"></use>
			                    </svg>
			                    	离线检查
			                    
			             </li>
					</ul>

                    
                    <div style="height:300px;line-height:300px;color:#fff;text-align:center;">--到底了--</div>
                </div>
            </div>
        </div>
      	<div class="div_fullscreen" style="display:none;">
    
	   		<div class="mui-content" >
	    		<div class="mui-scroll-wrapper">
		        	<div class="mui-scroll">
		            	<div style="margin-top:25px;padding:10px;" >
		                	<input type="search" class="mui-input-clear"   id="search_key"  placeholder="按关键字搜索问题" style="width:85%;float:left;">
		                    <div style="width:15%;float:right;padding-left:5px;">
		                    	<button type="button" class="mui-btn  mui-btn-primary"  onclick="search_hide()">Clear</button>
		                    </div>
		                </div>
		           
	                    <ul class="mui-table-view" style="margin-top:45px;" id="ul_key_list">
	                        
	                    </ul>
		        	</div>
		        </div>
		    </div>
		</div>
        
        <script src="hello-mui/js/mui.min.js"></script>
        
        <script src="hello-mui/js/mui.picker.js"></script>
        <script src="hello-mui/js/mui.poppicker.js"></script>
        <script src="hello-mui/js/city.data.js" type="text/javascript" charset="utf-8"></script>
        <script src="hello-mui/js/city.data-3.js" type="text/javascript" charset="utf-8"></script>
        <script>
            (function($, doc) {
             $.init();
             $.ready(function() {
                     //三级联示例 抵押物地址
                     var cityPicker1 = new $.PopPicker({
                                                       layer: 1
                                                       });
                     var riskData = [{
 						value: '1',
 						text: '一级风险'
 					}, {
 						value: '2',
 						text: '二级风险'
 					}, {
 						value: '3',
 						text: '三级风险'
 					}, {
 						value: '4',
 						text: '四级风险'
 					}, {
 						value: '5',
 						text: '五级风险'
 					}];
                     cityPicker1.setData(riskData);
               			
              
                     var risk_type = doc.getElementById('risk_type');
                     risk_type.addEventListener('tap', function(event) {
                          cityPicker1.show(function(items) {
                               risk_type.value = (items[0] || {}).text;
                               //返回 false 可以阻止选择框的关闭
                               //return false;
                               risk_type_value = (items[0] || {}).value;
                               });
                          }, false);
                     
                     //三级联示例 抵押物地址
                     var cityPicker2 = new $.PopPicker({
                                                       layer: 1
                                                       });
                     
                     var guarantData = [{
  						value: '1',
  						text: '保证'
  					}, {
  						value: '2',
  						text: '抵押'
  					}, {
  						value: '3',
  						text: '质押'
  					}, {
  						value: '4',
  						text: '留置'
  					}, {
  						value: '5',
  						text: '定金'
  					}, {
  						value: '9',
  						text: '其他'
  					}];
                     cityPicker2.setData(guarantData);
                     
                     
                     var guarant_type = doc.getElementById('guarant_type');
                     guarant_type.addEventListener('tap', function(event) {
                                                cityPicker2.show(function(items) {
                                                                 guarant_type.value = (items[0] || {}).text ;
                                                                 //返回 false 可以阻止选择框的关闭
                                                                 //return false;
                                                                 guarant_type_value = (items[0] || {}).value;
                                                                 });
                                                }, false);
                     
                     
                     //三级联示例 抵押物地址
/*                      var cityPicker3 = new $.PopPicker({
                                                       layer: 1
                                                       });
                     cityPicker3.setData(categoryData);
                     
                     
                     var category = doc.getElementById('category');
                     category.addEventListener('tap', function(event) {
                                                cityPicker3.show(function(items) {
                                                                 category.value = (items[0] || {}).text;
                                                                 //返回 false 可以阻止选择框的关闭
                                                                 //return false;
                                                                 category_value = (items[0] || {}).value;
                                                                 });
                                                }, false); */
                     
                     
                     });
             })(mui, document);
        </script>
    </body>
</html>
